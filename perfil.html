<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Perfil do usu√°rio - Guarini e-sport">
  <title>Meu Perfil - Guarini e-sport</title>
  <link rel="icon" href="favicon.png" type="image/png">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="perfil.css">
  <meta name="theme-color" content="#ffad00">
</head>

<body>
  <a id="topo"></a>

  <header>
    <div class="header-wrapper">
      <!-- Navega√ß√£o Desktop - Esquerda -->
      <nav class="nav-group left-nav">
        <ul>
          <li><a href="loja.html">Loja</a></li>
          <li><a href="sobre.html">Sobre</a></li>
        </ul>
      </nav>
      
      <!-- Logo Central -->
      <div class="logo-center">
        <a href="index.html" aria-label="In√≠cio">
          <img src="./logos/Guarini.png" alt="Guarini e-sport" class="header-logo">
        </a>
      </div>

      <!-- Navega√ß√£o Desktop - Direita -->
      <nav class="nav-group right-nav">
        <ul>
          <li><a href="equipes.html">Times</a></li>
          <li><a href="material.html">Material</a></li>
        </ul>
      </nav>
      
      <!-- Bot√£o Menu Mobile -->
      <button class="menu-toggle" aria-label="Menu">
        <span></span>
        <span></span>
        <span></span>
      </button>
      
      <!-- Menu Mobile -->
      <nav class="mobile-menu">
        <ul>
          <li><a href="index.html">In√≠cio</a></li>
          <li><a href="sobre.html">Sobre</a></li>
          <li><a href="equipes.html">Times</a></li>
          <li><a href="loja.html">Loja</a></li>
          <li><a href="material.html">Material</a></li>
          <li><a href="contato.html">Contato</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <!-- Menu dropdown do usu√°rio -->
  <div class="user-menu-container">
    <button class="user-menu-toggle" id="userMenuToggle" aria-label="Menu do usu√°rio">
      <span></span>
      <span></span>
      <span></span>
    </button>
    
    <div class="user-dropdown" id="userDropdown">
      <div class="user-dropdown-header" id="userDropdownHeader">
        <span>Ol√°, visitante!</span>
      </div>
      <ul class="user-dropdown-list">
        <li><a href="perfil.html" id="perfilLink" class="ativo">Perfil</a></li>
        <li><a href="#" id="authLink">Login</a></li>
      </ul>
    </div>
  </div>

   <div class="profile-search-container">
    <div class="profile-search-wrapper">
      <input 
        type="text" 
        id="profileSearchInput" 
        class="profile-search-input" 
        placeholder="Search Player ID..."
        maxlength="7"
      >
      <button class="profile-search-btn" id="profileSearchBtn" title="Search Profile">
        üîç
      </button>
    </div>
    <div class="profile-search-results" id="profileSearchResults"></div>
  </div>

  <main>
    <section class="perfil-section">
      <h2>Perfil</h2>
      
      <!-- Card de Perfil -->
      <div class="perfil-card">
        <!-- Foto de Perfil -->
        <div class="perfil-avatar-container">
          <div class="perfil-avatar" id="perfilAvatar">
            <img src="./estatisticas-shad/images/backgrounds/pikachu-left-bg.png" alt="Avatar do usu√°rio" id="avatarImg">
          </div>
        </div>

        <!-- Informa√ß√µes do Usu√°rio -->
        <div class="perfil-info">
          <div class="perfil-nome-container">
            <h3 id="perfilNomeDisplay">Nome do Usu√°rio</h3>
            <button class="btn-edit-nome" id="btnEditNome" title="Editar nome">
              ‚úèÔ∏è
            </button>
          </div>
          <input type="text" id="perfilNomeInput" class="perfil-nome-input" style="display: none;" maxlength="30">
          <p class="perfil-email" id="perfilEmail">usuario@email.com</p>
          <!-- Player ID Section -->
          <div class="perfil-player-id-container">
            <p class="perfil-player-id-label">Player ID:</p>
            
            <!-- Exibi√ß√£o do ID (quando j√° cadastrado) -->
            <p class="perfil-player-id-display" id="playerIdDisplay" style="display: none;">-</p>
            
            <!-- Input para cadastrar ID (quando n√£o tem ID) -->
            <div class="perfil-player-id-input-group" id="playerIdInputGroup" style="display: none;">
              <input 
                type="text" 
                id="playerIdInput" 
                class="perfil-player-id-input" 
                placeholder="Ex: A1B2C3D"
                maxlength="7"
                pattern="[A-Za-z0-9]{7}"
              >
              <button class="btn-save-player-id" id="btnSavePlayerId">
                üíæ Save
              </button>
              <button class="btn-help-player-id" id="btnHelpPlayerId" title="Help">
                ?
              </button>
            </div>
          </div>

          <!-- Modal de Ajuda -->
          <div class="modal-help-overlay" id="modalHelpPlayerId">
            <div class="modal-help-content">
              <button class="modal-help-close" id="btnCloseHelpModal">‚úï</button>
              <h3>üìã How to find your Player ID</h3>
              <p>
                <strong>Step 1:</strong> Open Pok√©mon UNITE on your device<br><br>
                <strong>Step 2:</strong> Go to your profile (tap your trainer card)<br><br>
                <strong>Step 3:</strong> Look for your <strong>Player ID</strong> (it's a 7-character code with letters and numbers)<br><br>
                <strong>Step 4:</strong> Copy this ID and paste it here<br><br>
                ‚ö†Ô∏è <strong>Important:</strong> This ID can only be set once and cannot be changed later. Make sure you enter the correct ID!
              </p>
            </div>
          </div>
        </div>
      </div>  

      <!-- √Årea para builds salvas -->
      <section class="perfil-section">
        <h2>Saved Builds</h2>
        
        <div class="perfil-content">
          <div id="builds-container-perfil" class="builds-container">
            <div class="builds-loading">
              Working...
            </div>
          </div>
        </div>
      </section>

      <!-- √Érea para Battle Ribbons List -->
      <section class="perfil-section">
        <h2>Battle Ribbons List</h2>
        
        <div class="perfil-content">
          <!-- Gold Ribbon -->
          <div class="ribbon-tier">
            <div class="ribbon-icon-container">
              <img src="./estatisticas-shad/images/icons/dourado.png" alt="Gold Ribbon" class="ribbon-icon">
            </div>
            <div class="ribbon-pokemon-list" id="goldRibbonList" data-tier="gold">
              <button class="btn-add-pokemon" data-tier="gold">+</button>
            </div>
          </div>

          <!-- Blue Ribbon -->
          <div class="ribbon-tier">
            <div class="ribbon-icon-container">
              <img src="./estatisticas-shad/images/icons/azul.png" alt="Blue Ribbon" class="ribbon-icon">
            </div>
            <div class="ribbon-pokemon-list" id="blueRibbonList" data-tier="blue">
              <button class="btn-add-pokemon" data-tier="blue">+</button>
            </div>
          </div>

          <!-- Green Ribbon -->
          <div class="ribbon-tier">
            <div class="ribbon-icon-container">
              <img src="./estatisticas-shad/images/icons/verde.png" alt="Green Ribbon" class="ribbon-icon">
            </div>
            <div class="ribbon-pokemon-list" id="greenRibbonList" data-tier="green">
              <button class="btn-add-pokemon" data-tier="green">+</button>
            </div>
          </div>

          <!-- Bot√µes de A√ß√£o -->
          <div class="ribbon-actions">
            <button class="btn-ribbon-action btn-save-ribbons" id="btnSaveRibbons">
              üíæ Save List
            </button>
          </div>
        </div>
      </section>

      <!-- Modal de Sele√ß√£o de Pok√©mon para Ribbons -->
  <div class="modal-overlay" id="modalRibbonPokemon">
    <div class="modal-content modal-ribbon-content">
      <div class="modal-header">
        <h3>Select Pok√©mon</h3>
        <button class="modal-close" id="btnCloseRibbonModal">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="ribbon-pokemon-grid" id="ribbonPokemonGrid">
          <!-- Pok√©mons ser√£o carregados aqui -->
        </div>
      </div>
    </div>
  </div>
  </main>

  <!-- Modal de Sele√ß√£o de Avatar -->
  <div class="modal-overlay" id="modalAvatar">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Escolha seu Avatar</h3>
        <button class="modal-close" id="btnCloseModal">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="avatar-grid" id="avatarGrid">
          <!-- As imagens ser√£o carregadas aqui dinamicamente -->
        </div>
      </div>
    </div>
  </div>

  <footer>
    <div class="footer-content">
      <div class="footer-info">
        <p>&copy; 2019 Guarini e-sport. Todos os direitos reservados.</p>
        <p><a href="https://linktr.ee/guariniesports" target="_blank">Conhe√ßa nossas redes sociais</a></p>
        <p>Created by: Lobo & Shad</p>
      </div>
    </div>
  </footer>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { 
    getAuth, 
    onAuthStateChanged, 
    signOut,
    updateProfile
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import { 
  getFirestore, 
  doc, 
  getDoc,
  collection, 
  query, 
  where, 
  getDocs,
  setDoc,      // ‚Üê Adicione estas 3
  updateDoc,   // ‚Üê Adicione estas 3
  deleteDoc    // ‚Üê Adicione estas 3 (voc√™ usa no excluirBuild)
} from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

// Importar fun√ß√µes do perfil.js
  import { initRibbons } from './perfil.js';

  const firebaseConfig = {
    apiKey: "AIzaSyC9LLCXrQTHBagQxaChBazSfS5E4gUPIoI",
    authDomain: "site-grn.firebaseapp.com",
    projectId: "site-grn",
    storageBucket: "site-grn.firebasestorage.app",
    messagingSenderId: "27613322806",
    appId: "1:27613322806:web:ad4dc08ce043f19d530297",
    measurementId: "G-84NHN394WF"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore();

  // ========================================
  // ELEMENTOS DO DOM - BUSCA DE PERFIL
  // ========================================
  const profileSearchBtn = document.getElementById('profileSearchBtn');
  const profileSearchInput = document.getElementById('profileSearchInput');
  const profileSearchResults = document.getElementById('profileSearchResults');

  // ========================================
  // BUSCA DE PERFIL - COM BUSCA AUTOM√ÅTICA
  // ========================================

  // Fun√ß√£o para buscar perfil
  async function buscarPerfil() {
    const playerId = profileSearchInput.value.trim().toUpperCase();
    
    if (!playerId) {
      profileSearchResults.classList.remove('show');
      return;
    }
    
    if (playerId.length !== 7) {
      profileSearchResults.classList.remove('show');
      return;
    }
    
    try {
      profileSearchResults.innerHTML = '<div class="profile-search-no-results">üîç Searching...</div>';
      profileSearchResults.classList.add('show');
      
      console.log('üîç Buscando Player ID:', playerId);
      
      const usuariosRef = collection(db, "usuarios");
      const q = query(usuariosRef, where("playerId", "==", playerId));
      
      console.log('üì° Query criada, executando busca...');
      
      const querySnapshot = await getDocs(q);
      
      console.log('üì¶ Resultado da busca:', {
        empty: querySnapshot.empty,
        size: querySnapshot.size
      });
      
      if (querySnapshot.empty) {
        console.log('‚ùå Nenhum usu√°rio encontrado com Player ID:', playerId);
        profileSearchResults.innerHTML = '<div class="profile-search-no-results">‚ùå Player not found</div>';
        return;
      }
      
      const userDoc = querySnapshot.docs[0];
      const userData = userDoc.data();
      const userId = userDoc.id;
      
      console.log('‚úÖ Usu√°rio encontrado:', {
        userId: userId,
        playerId: userData.playerId,
        displayName: userData.displayName,
        email: userData.email
      });
      
      profileSearchResults.innerHTML = `
        <div class="profile-search-result-item" style="background: rgba(255, 173, 0, 0.1); cursor: default;">
          <div style="flex: 1;">
            <div style="color: #ffad00; font-weight: bold; margin-bottom: 5px;">
              ‚úÖ Player found!
            </div>
            <div style="color: #fff; font-size: 13px;">
              ${userData.displayName || 'Anonymous'}
            </div>
            <div style="color: #aaa; font-size: 11px; margin-top: 3px;">
              ID: ${userData.playerId}
            </div>
          </div>
        </div>
        <div style="margin-top: 10px; text-align: center;">
          <button 
            onclick="window.location.href='perfil-view.html?uid=${userId}'" 
            style="background: linear-gradient(45deg, #ff7500, #ffad00); border: none; padding: 10px 20px; border-radius: 8px; color: #000; font-weight: bold; cursor: pointer; transition: all 0.3s ease;"
            onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 5px 15px rgba(255, 173, 0, 0.5)'"
            onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'"
          >
            üë§ View Profile
          </button>
        </div>
      `;
      
    } catch (error) {
      console.error('‚ùå Erro ao buscar perfil:', error);
      console.error('Detalhes do erro:', {
        message: error.message,
        code: error.code,
        stack: error.stack
      });
      
      profileSearchResults.innerHTML = `
        <div class="profile-search-no-results" style="color: #ff6b6b;">
          ‚ùå Search error<br>
          <small style="font-size: 11px; color: #aaa; margin-top: 5px; display: block;">
            ${error.message}
          </small>
        </div>
      `;
    }
  }

  // Toggle da barra de busca
  profileSearchBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    console.log('üñ±Ô∏è Bot√£o de busca clicado');
    profileSearchInput.classList.toggle('active');
    
    if (profileSearchInput.classList.contains('active')) {
      console.log('‚úÖ Input ativado');
      profileSearchInput.focus();
    } else {
      console.log('‚ùå Input desativado');
      profileSearchInput.value = '';
      profileSearchResults.classList.remove('show');
    }
  });

  // Buscar ao pressionar Enter
  profileSearchInput.addEventListener('keypress', async (e) => {
    if (e.key === 'Enter') {
      console.log('‚å®Ô∏è Enter pressionado');
      await buscarPerfil();
    }
  });

  // Valida√ß√£o e busca autom√°tica ao digitar 7 caracteres
  profileSearchInput.addEventListener('input', async (e) => {
    e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
    if (e.target.value.length > 7) {
      e.target.value = e.target.value.slice(0, 7);
    }
    
    if (e.target.value.length === 7) {
      console.log('üéØ 7 caracteres digitados - buscando automaticamente...');
      await buscarPerfil();
    } else {
      profileSearchResults.classList.remove('show');
    }
  });

  // Fechar ao clicar fora
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.profile-search-container')) {
      profileSearchInput.classList.remove('active');
      profileSearchResults.classList.remove('show');
    }
  });
  // ===== FUN√á√ïES DE BUILDS =====
  
  // Fun√ß√£o auxiliar para capitalizar primeira letra
  function capitalizeFirst(str) {
    if (!str) return '';
    return str.charAt(0).toUpperCase() + str.slice(1);
  }

  // Fun√ß√£o para criar o HTML de um card de build
function createBuildCard(build) {
  const pokemonImage = build.pokemon ? 
    `./estatisticas-shad/images/backgrounds/${build.pokemon}-left-bg.png` : 
    './estatisticas-shad/images/backgrounds/placeholder.png';
  
  // Obter role do Pok√©mon (voc√™ precisar√° importar pokemonRoles do util.js)
  const pokemonName = capitalizeFirst(build.pokemon);
  const roleInfo = getPokemonRole(build.pokemon);
  
  // Battle Item
  const battleItemHTML = build.battleItem ? `
    <div class="build-item-circle">
      <img src="./estatisticas-shad/images/battle-items/${build.battleItem}.png" 
           alt="Battle Item"
           onerror="this.style.display='none'">
    </div>
  ` : '';
  
  // Held Items (m√°ximo 3)
  const heldItemsHTML = build.heldItems && build.heldItems.length > 0 ? 
    build.heldItems.slice(0, 3).map(item => `
      <div class="build-item-circle">
        <img src="./estatisticas-shad/images/held-itens/${item.key}.png" 
             alt="${item.name}"
             title="${item.name}${item.stacks > 0 ? ` (${item.stacks} stacks)` : ''}"
             onerror="this.style.display='none'">
      </div>
    `).join('') : 
    '<span style="color: #888; font-size: 10px;">No items</span>';
  
  return `
    <div class="build-card-perfil">
      <div class="build-pokemon-image">
        <img src="${pokemonImage}" 
             alt="${pokemonName}"
             onerror="this.src='./estatisticas-shad/images/backgrounds/placeholder.png'">
      </div>
      
      <h3 class="build-pokemon-name">${pokemonName}</h3>
      
      ${roleInfo ? `
        <div class="build-pokemon-role">
          <img src="./estatisticas-shad/images/roles/${roleInfo.icon}.png" 
               alt="${roleInfo.name}"
               onerror="this.style.display='none'">
          <span>${roleInfo.name}</span>
        </div>
      ` : ''}
      
      <div class="build-details">
        <p class="build-name-header">${build.buildName}</p>
        
        <div class="build-items-section">
          ${battleItemHTML ? `
            <div class="build-battle-item">
              ${battleItemHTML}
            </div>
          ` : ''}
          
          <div class="build-held-items">
            ${heldItemsHTML}
          </div>
        </div>
        
        <div class="build-actions-perfil">
          <button class="btn-build-action-perfil btn-edit-perfil" data-build-id="${build.id}">
            ‚úèÔ∏è Edit
          </button>
          <button class="btn-build-action-perfil btn-delete-perfil" data-build-id="${build.id}">
            üóëÔ∏è Delete
          </button>
        </div>
      </div>
    </div>
  `;
}

// Fun√ß√£o auxiliar para obter role do Pok√©mon
function getPokemonRole(pokemonKey) {
  return null;
}

  // Fun√ß√£o para editar build (redireciona para calculadora)
  function editarBuild(buildId) {
    localStorage.setItem('loadBuildId', buildId);
    window.location.href = 'damage-calculator.html';
  }

  // Fun√ß√£o para excluir build
  async function excluirBuild(buildId, userId) {
    const confirmacao = confirm('Tem certeza que deseja excluir esta build? Esta a√ß√£o n√£o pode ser desfeita.');
    
    if (!confirmacao) return;
    
    try {
      const buildRef = doc(db, "usuarios", userId, "builds", buildId);
      await deleteDoc(buildRef);
      
      console.log('‚úÖ Build deletada:', buildId);
      alert('‚úÖ Build exclu√≠da com sucesso!');
      
      // Recarregar lista de builds
      await carregarBuildsUsuario(userId);
      
    } catch (error) {
      console.error('‚ùå Erro ao excluir build:', error);
      alert(`‚ùå Erro ao excluir build: ${error.message}`);
    }
  }

  // Fun√ß√£o para carregar e exibir as builds do usu√°rio
  async function carregarBuildsUsuario(userId) {
    const buildsContainer = document.getElementById('builds-container-perfil');
    
    if (!buildsContainer) {
      console.error('‚ùå Container de builds n√£o encontrado');
      return;
    }
    
    try {
      buildsContainer.innerHTML = '<div class="builds-loading">Carregando builds...</div>';
      
      console.log('üîÑ Carregando builds do usu√°rio:', userId);
      
      // Buscar builds do usu√°rio
      const buildsRef = collection(db, "usuarios", userId, "builds");
      const buildsSnap = await getDocs(buildsRef);
      
      console.log('üì¶ Builds encontradas:', buildsSnap.size);
      
      if (buildsSnap.empty) {
        buildsContainer.innerHTML = `
          <div class="no-builds-message">
            Nenhuma build salva ainda.<br>
            Crie sua primeira build na calculadora!
          </div>
        `;
        return;
      }
      
      // Processar builds
      const builds = [];
      buildsSnap.forEach(docSnap => {
        builds.push({ id: docSnap.id, ...docSnap.data() });
      });
      
      // Ordenar por data de atualiza√ß√£o (mais recente primeiro)
      builds.sort((a, b) => {
        const dateA = a.updatedAt?.toDate() || new Date(0);
        const dateB = b.updatedAt?.toDate() || new Date(0);
        return dateB - dateA;
      });
      
      // Renderizar builds
      buildsContainer.innerHTML = builds.map(build => createBuildCard(build)).join('');
      
      // Adicionar event listeners
      const editButtons = buildsContainer.querySelectorAll('.btn-edit-perfil');
      const deleteButtons = buildsContainer.querySelectorAll('.btn-delete-perfil');
      
      editButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const buildId = btn.getAttribute('data-build-id');
          editarBuild(buildId);
        });
      });
      
      deleteButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const buildId = btn.getAttribute('data-build-id');
          excluirBuild(buildId, userId);
        });
      });
      
      console.log('‚úÖ Builds carregadas com sucesso!');
      
    } catch (error) {
      console.error('‚ùå Erro ao carregar builds:', error);
      buildsContainer.innerHTML = `
        <div class="no-builds-message" style="color: #ff6b6b;">
          ‚ùå Erro ao carregar builds: ${error.message}
        </div>
      `;
    }
  }

  // Elementos do DOM para Player ID
  const playerIdDisplay = document.getElementById('playerIdDisplay');
  const playerIdInputGroup = document.getElementById('playerIdInputGroup');
  const playerIdInput = document.getElementById('playerIdInput');
  const btnSavePlayerId = document.getElementById('btnSavePlayerId');
  const btnHelpPlayerId = document.getElementById('btnHelpPlayerId');
  const modalHelpPlayerId = document.getElementById('modalHelpPlayerId');
  const btnCloseHelpModal = document.getElementById('btnCloseHelpModal');

  // Fun√ß√£o para validar Player ID (7 caracteres alfanum√©ricos)
  function validarPlayerId(id) {
    const regex = /^[A-Za-z0-9]{7}$/;
    return regex.test(id);
  }

  // Fun√ß√£o para carregar Player ID do Firestore
  async function carregarPlayerId(userId) {
    try {
      const userDocRef = doc(db, "usuarios", userId);
      const userDocSnap = await getDoc(userDocRef);
      
      if (userDocSnap.exists()) {
        const userData = userDocSnap.data();
        
        if (userData.playerId) {
          // J√° tem ID cadastrado - exibir
          playerIdDisplay.textContent = userData.playerId;
          playerIdDisplay.style.display = 'block';
          playerIdInputGroup.style.display = 'none';
          console.log('‚úÖ Player ID carregado:', userData.playerId);
        } else {
          // N√£o tem ID - mostrar input
          playerIdDisplay.style.display = 'none';
          playerIdInputGroup.style.display = 'flex';
          console.log('‚ÑπÔ∏è Player ID n√£o cadastrado ainda');
        }
      } else {
        // Documento n√£o existe - mostrar input
        playerIdDisplay.style.display = 'none';
        playerIdInputGroup.style.display = 'flex';
      }
    } catch (error) {
      console.error('‚ùå Erro ao carregar Player ID:', error);
      playerIdDisplay.style.display = 'none';
      playerIdInputGroup.style.display = 'flex';
    }
  }

  // Fun√ß√£o para salvar Player ID no Firestore
  async function salvarPlayerId(userId, playerId) {
    try {
      btnSavePlayerId.disabled = true;
      btnSavePlayerId.textContent = 'üíæ Saving...';
      
      const userDocRef = doc(db, "usuarios", userId);
      const userDocSnap = await getDoc(userDocRef);
      
      if (userDocSnap.exists()) {
        // Atualizar documento existente
        await updateDoc(userDocRef, {
          playerId: playerId.toUpperCase()
        });
      } else {
        // Criar novo documento
        await setDoc(userDocRef, {
          email: currentUser.email,
          role: "user",
          playerId: playerId.toUpperCase(),
          createdAt: new Date()
        });
      }
      
      console.log('‚úÖ Player ID salvo com sucesso:', playerId);
      alert('‚úÖ Player ID saved successfully!\n\nYour ID: ' + playerId.toUpperCase());
      
      // Atualizar interface
      playerIdDisplay.textContent = playerId.toUpperCase();
      playerIdDisplay.style.display = 'block';
      playerIdInputGroup.style.display = 'none';
      playerIdInput.value = '';
      
    } catch (error) {
      console.error('‚ùå Erro ao salvar Player ID:', error);
      alert('‚ùå Error saving Player ID: ' + error.message);
    } finally {
      btnSavePlayerId.disabled = false;
      btnSavePlayerId.textContent = 'üíæ Save';
    }
  }

  // Event listener para bot√£o de salvar Player ID
  btnSavePlayerId.addEventListener('click', async () => {
    const playerId = playerIdInput.value.trim().toUpperCase();
    
    if (!playerId) {
      alert('‚ö†Ô∏è Please enter your Player ID');
      return;
    }
    
    if (!validarPlayerId(playerId)) {
      alert('‚ö†Ô∏è Invalid Player ID!\n\nThe ID must be exactly 7 characters (letters and numbers only).\n\nExample: A1B2C3D');
      return;
    }
    
    const confirmacao = confirm(
      '‚ö†Ô∏è IMPORTANT: You can only set your Player ID ONCE!\n\n' +
      'Player ID: ' + playerId + '\n\n' +
      'Are you sure this is correct?\n\n' +
      'This cannot be changed later!'
    );
    
    if (!confirmacao) {
      return;
    }
    
    if (currentUser) {
      await salvarPlayerId(currentUser.uid, playerId);
    } else {
      alert('‚ùå You must be logged in to save your Player ID');
    }
  });

  // Valida√ß√£o em tempo real do input
  playerIdInput.addEventListener('input', (e) => {
    // Converter para mai√∫sculas e remover caracteres inv√°lidos
    e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
    
    // Limitar a 7 caracteres
    if (e.target.value.length > 7) {
      e.target.value = e.target.value.slice(0, 7);
    }
  });

  // Salvar ao pressionar Enter
  playerIdInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      btnSavePlayerId.click();
    }
  });

  // Event listeners para modal de ajuda
  btnHelpPlayerId.addEventListener('click', () => {
    modalHelpPlayerId.classList.add('show');
  });

  btnCloseHelpModal.addEventListener('click', () => {
    modalHelpPlayerId.classList.remove('show');
  });

  modalHelpPlayerId.addEventListener('click', (e) => {
    if (e.target === modalHelpPlayerId) {
      modalHelpPlayerId.classList.remove('show');
    }
  });
  
  // Fun√ß√£o para carregar todas as imagens da pasta sprites
  async function carregarImagensSprites() {
    const avatares = [];
    const pastaPrincial = './estatisticas-shad/images/backgrounds/';
    
    const nomesBase = [
        'absol', 'aegislash', 'alcremie', 'armarouge', 'azumarill',
        'blastoise', 'blaziken', 'blissey', 'buzzwole', 'ceruledge',
        'chandelure', 'charizard', 'cinderace', 'clefable', 'comfey',
        'cramorant', 'crustle', 'darkrai', 'decidueye', 'delphox',
        'dhelmise', 'dodrio', 'dragapult', 'dragonite', 'duraludon',
        'eldegoss', 'empoleon', 'espeon', 'falinks', 'garchomp',
        'gardevoir', 'gengar', 'glaceon', 'goodra', 'greninja',
        'gyarados', 'hooh', 'hoopa', 'inteleon', 'lapras',
        'latias', 'latios', 'leafeon', 'lucario', 'machamp',
        'mamoswine', 'megacharizardx', 'megalucario', 'metagross', 'meowscara',
        'mew', 'mewtwox', 'mewtwoy', 'mimikyu', 'miraidon',
        'mrmime', 'ninetales', 'pawmot', 'pikachu', 'psyduck',
        'raichu', 'rapidash', 'sableye', 'scizor', 'scyther',
        'slowbro', 'snorlax', 'suicune', 'sylveon', 'talonflame',
        'tinkaton', 'trevenant', 'tsareena', 'tyranitar', 'umbreon',
        'urshifu', 'vaporeon','venusaur', 'wigglytuff', 'zacian', 'zeraora',
        'zoroark'
    ];
    
    for (const nome of nomesBase) {
      const img = new Image();
      img.src = `${pastaPrincial}${nome}.png`;
      
      await new Promise((resolve) => {
        img.onload = () => {
          avatares.push(nome);
          resolve();
        };
        img.onerror = () => {
          console.log(`Imagem ${nome}.png n√£o encontrada`);
          resolve();
        };
        setTimeout(resolve, 2000);
      });
    }
    
    return avatares.length > 0 ? avatares : nomesBase;
  }

  let pokemonList = [];

  // Elementos do DOM
  const userMenuToggle = document.getElementById('userMenuToggle');
  const userDropdown = document.getElementById('userDropdown');
  const userDropdownHeader = document.getElementById('userDropdownHeader');
  const authLink = document.getElementById('authLink');
  const perfilLink = document.getElementById('perfilLink');
  const perfilNomeDisplay = document.getElementById('perfilNomeDisplay');
  const perfilNomeInput = document.getElementById('perfilNomeInput');
  const btnEditNome = document.getElementById('btnEditNome');
  const perfilEmail = document.getElementById('perfilEmail');
  const avatarImg = document.getElementById('avatarImg');
  const btnChangeAvatar = document.getElementById('btnChangeAvatar');
  const modalAvatar = document.getElementById('modalAvatar');
  const btnCloseModal = document.getElementById('btnCloseModal');
  const avatarGrid = document.getElementById('avatarGrid');

  let currentUser = null;

  // Toggle do menu dropdown
  userMenuToggle.addEventListener('click', function(e) {
    e.stopPropagation();
    this.classList.toggle('active');
    userDropdown.classList.toggle('show');
  });

  // Fechar dropdown ao clicar fora
  document.addEventListener('click', function(e) {
    if (!userMenuToggle.contains(e.target) && !userDropdown.contains(e.target)) {
      userMenuToggle.classList.remove('active');
      userDropdown.classList.remove('show');
    }
  });

  // Fechar dropdown ao clicar em um link
  userDropdown.querySelectorAll('a').forEach(link => {
    link.addEventListener('click', function() {
      userMenuToggle.classList.remove('active');
      userDropdown.classList.remove('show');
    });
  });

  // Carregar avatares no modal
  async function loadAvatars() {
    avatarGrid.innerHTML = '<p style="color: #ffad00; text-align: center; grid-column: 1/-1;">Carregando avatares...</p>';
    
    if (pokemonList.length === 0) {
      pokemonList = await carregarImagensSprites();
    }
    
    avatarGrid.innerHTML = '';
    
    if (pokemonList.length === 0) {
      avatarGrid.innerHTML = '<p style="color: #ff7500; text-align: center; grid-column: 1/-1;">Nenhum avatar dispon√≠vel</p>';
      return;
    }
    
    pokemonList.forEach(pokemon => {
      const avatarOption = document.createElement('div');
      avatarOption.className = 'avatar-option';
      avatarOption.innerHTML = `<img src="./estatisticas-shad/images/backgrounds/${pokemon}-left-bg.png" alt="${pokemon}" onerror="this.parentElement.style.display='none'">`;
      avatarOption.addEventListener('click', () => selectAvatar(pokemon));
      avatarGrid.appendChild(avatarOption);
    });
  }

  // Selecionar avatar
  // Selecionar avatar
async function selectAvatar(pokemon) {
  if (!currentUser) {
    alert('‚ùå Voc√™ precisa estar logado para alterar o avatar');
    return;
  }
  
  try {
    const avatarPath = `./estatisticas-shad/images/backgrounds/${pokemon}-left-bg.png`;
    
    // Salvar no Firestore
    const userDocRef = doc(db, "usuarios", currentUser.uid);
    const userDocSnap = await getDoc(userDocRef);
    
    if (userDocSnap.exists()) {
      await updateDoc(userDocRef, {
        avatar: avatarPath,
        updatedAt: new Date()
      });
    } else {
      await setDoc(userDocRef, {
        email: currentUser.email,
        role: "user",
        avatar: avatarPath,
        createdAt: new Date()
      });
    }
    
    // Atualizar interface
    avatarImg.src = avatarPath;
    modalAvatar.classList.remove('show');
    
    console.log('‚úÖ Avatar atualizado:', pokemon);
    
  } catch (error) {
    console.error('‚ùå Erro ao salvar avatar:', error);
    alert('‚ùå Erro ao salvar avatar: ' + error.message);
  }
}

  // Abrir modal ao clicar no avatar
  const perfilAvatar = document.getElementById('perfilAvatar');
  perfilAvatar.addEventListener('click', () => {
    loadAvatars();
    modalAvatar.classList.add('show');
  });

  // Fechar modal
  btnCloseModal.addEventListener('click', () => {
    modalAvatar.classList.remove('show');
  });

  // Fechar modal ao clicar fora
  modalAvatar.addEventListener('click', (e) => {
    if (e.target === modalAvatar) {
      modalAvatar.classList.remove('show');
    }
  });

  // Editar nome
  btnEditNome.addEventListener('click', () => {
    perfilNomeInput.value = perfilNomeDisplay.textContent;
    perfilNomeDisplay.style.display = 'none';
    btnEditNome.style.display = 'none';
    perfilNomeInput.style.display = 'block';
    perfilNomeInput.focus();
  });

  // Salvar nome ao pressionar Enter ou perder foco
  async function salvarNome() {
    const novoNome = perfilNomeInput.value.trim();
    
    if (!novoNome || novoNome === perfilNomeDisplay.textContent) {
      perfilNomeInput.style.display = 'none';
      perfilNomeDisplay.style.display = 'block';
      btnEditNome.style.display = 'inline-block';
      return;
    }
    
    if (!currentUser) {
      alert('‚ùå Voc√™ precisa estar logado para alterar o nome');
      return;
    }
    
    try {
      btnEditNome.disabled = true;
      perfilNomeInput.disabled = true;
      
      // Atualizar no Firestore
      const userDocRef = doc(db, "usuarios", currentUser.uid);
      const userDocSnap = await getDoc(userDocRef);
      
      if (userDocSnap.exists()) {
        await updateDoc(userDocRef, {
          displayName: novoNome,
          updatedAt: new Date()
        });
      } else {
        await setDoc(userDocRef, {
          email: currentUser.email,
          role: "user",
          displayName: novoNome,
          createdAt: new Date()
        });
      }
      
      // Atualizar no Firebase Auth
      await updateProfile(currentUser, {
        displayName: novoNome
      });
      
      perfilNomeDisplay.textContent = novoNome;
      // Atualizar interface
          userDropdownHeader.innerHTML = `
            <img src="${avatarPath}" alt="Avatar" class="dropdown-avatar">
            <span>Ol√°, ${novoNome}!</span>
          `;
      
      console.log('‚úÖ Nome atualizado com sucesso:', novoNome);
      alert('‚úÖ Nome atualizado com sucesso!');
      
    } catch (error) {
      console.error('‚ùå Erro ao atualizar nome:', error);
      alert('‚ùå Erro ao atualizar nome: ' + error.message);
    } finally {
      btnEditNome.disabled = false;
      perfilNomeInput.disabled = false;
      perfilNomeInput.style.display = 'none';
      perfilNomeDisplay.style.display = 'block';
      btnEditNome.style.display = 'inline-block';
    }
  }

  perfilNomeInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      salvarNome();
    }
  });

  perfilNomeInput.addEventListener('blur', salvarNome);

  // Fun√ß√£o para atualizar a interface
// Fun√ß√£o para atualizar a interface
async function updateUI(user) {
  currentUser = user;
  
  if (user) {
    try {
      // üî• BUSCAR DADOS DO FIRESTORE
      const userDocRef = doc(db, "usuarios", user.uid);
      const userDocSnap = await getDoc(userDocRef);
      
      let displayName = user.displayName || user.email.split('@')[0];
      let avatarPath = './estatisticas-shad/images/sprites/pikachu.png';
      
      // Se existe documento no Firestore, usar os dados de l√°
      if (userDocSnap.exists()) {
        const userData = userDocSnap.data();
        if (userData.displayName) {
          displayName = userData.displayName;
        }
        if (userData.avatar) {
          avatarPath = userData.avatar;
        }
      }
      
      // Atualizar interface
      perfilNomeDisplay.textContent = displayName;
      perfilEmail.textContent = user.email;
      avatarImg.src = avatarPath;
      
      // Atualizar interface
          userDropdownHeader.innerHTML = `
            <img src="${avatarPath}" alt="Avatar" class="dropdown-avatar">
            <span>Ol√°, ${displayName}!</span>
          `;
      authLink.textContent = 'Logout';
      authLink.onclick = function(e) {
        e.preventDefault();
        handleLogout();
      };
      perfilLink.style.display = 'block';
      
      if (btnChangeAvatar) btnChangeAvatar.disabled = false;
      btnEditNome.disabled = false;
      
      console.log('‚úÖ Usu√°rio logado:', user.email);
      
      // Carregar dados do usu√°rio
      await carregarBuildsUsuario(user.uid);
      await carregarPlayerId(user.uid);
      
    } catch (error) {
      console.error('‚ùå Erro ao carregar dados do usu√°rio:', error);
      // Fallback para dados b√°sicos
      perfilNomeDisplay.textContent = user.displayName || user.email.split('@')[0];
      perfilEmail.textContent = user.email;
    }
    
  } else {
    window.location.href = 'login.html';
  }
}

  // Fun√ß√£o para fazer logout
  async function handleLogout() {
  const confirmar = confirm('Deseja realmente fazer logout?');
  if (confirmar) {
    try {
      // üî• LIMPAR DADOS DO LOCALSTORAGE
      localStorage.removeItem('userDisplayName');
      localStorage.removeItem('userAvatar');
      
      await signOut(auth);
      alert('Logout realizado com sucesso!');
      window.location.href = 'index.html';
    } catch (error) {
      console.error('Erro no logout:', error);
      alert('Erro ao fazer logout. Tente novamente.');
    }
  }
}

  onAuthStateChanged(auth, (user) => {
    updateUI(user);
    
    carregarImagensSprites().then(lista => {
      pokemonList = lista;
      console.log(`${pokemonList.length} avatares carregados`);
      
      // Inicializar sistema de ribbons ap√≥s carregar pok√©mons
      if (user && pokemonList.length > 0) {
        initRibbons(user.uid, pokemonList, db);
      }
    });
  });
</script>

  <!-- Scripts principais -->
  <script>
    // Funcionalidade do menu mobile
    const menuToggle = document.querySelector('.menu-toggle');
    const mobileMenu = document.querySelector('.mobile-menu');

    menuToggle.addEventListener('click', function() {
      this.classList.toggle('ativo');
      mobileMenu.classList.toggle('ativo');
    });

    // Fechar menu ao clicar em um link
    const mobileLinks = document.querySelectorAll('.mobile-menu a');
    mobileLinks.forEach(link => {
      link.addEventListener('click', function() {
        menuToggle.classList.remove('ativo');
        mobileMenu.classList.remove('ativo');
      });
    });

    // Fechar menu ao redimensionar para desktop
    window.addEventListener('resize', function() {
      if (window.innerWidth > 900) {
        menuToggle.classList.remove('ativo');
        mobileMenu.classList.remove('ativo');
      }
    });
  </script>

</body>
</html>