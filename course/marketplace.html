<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Marketplace de Coaches | Guariní</title>
  <link rel="icon" href="../favicon.png" type="image/png" />
  <link rel="stylesheet" href="../style.css" />
  <!--
    ATENÇÃO: Este arquivo NÃO contém CSS — ele respeita o CSS já existente do seu site.
    Use as classes fornecidas ou substitua por classes do seu framework.
  -->
</head>
<body>
  <main id="coach-marketplace" class="page-coach-marketplace">
    <header class="pm-header">
      <h1 class="pm-title">Coaching & Mentoria — Ofereça e contrate</h1>
      <p class="pm-subtitle">Encontre coaches para melhorar seu desempenho ou publique seu serviço de coach/mentoria.</p>
    </header>

    <!-- Formulário para criar anúncio (visível para quem for vendedor) -->
    <section id="create-listing" class="pm-create-listing" aria-label="Criar anúncio de coach">
      <h2>Publicar serviço de Coach / Mentoria</h2>
      <form id="listing-form" class="pm-form" enctype="multipart/form-data" novalidate>
        <div class="field">
          <label for="coach-name">Nome (ex: nick ou nome real)</label>
          <input id="coach-name" name="name" class="pm-input" required maxlength="60" />
        </div>

        <div class="field">
          <label for="coach-title">Título do serviço (ex: Coach de VGC — Treino avançado)</label>
          <input id="coach-title" name="title" class="pm-input" required maxlength="80" />
        </div>

        <div class="field">
          <label for="coach-game">Jogo / Modalidade</label>
          <input id="coach-game" name="game" class="pm-input" required />
        </div>

        <div class="field">
          <label for="service-type">Tipo de serviço</label>
          <select id="service-type" name="type" class="pm-select" required>
            <option value="aula">Aula avulsa</option>
            <option value="pacote">Pacote</option>
            <option value="mentoria">Mentoria</option>
          </select>
        </div>

        <div class="field">
          <label for="price">Preço (BRL)</label>
          <input id="price" name="price" class="pm-input" type="number" min="0" step="0.01" required />
        </div>

        <div class="field">
          <label for="currency">Moeda</label>
          <input id="currency" name="currency" class="pm-input" value="BRL" />
        </div>

        <div class="field">
          <label for="duration">Duração aproximada (minutos)</label>
          <input id="duration" name="duration" class="pm-input" type="number" min="5" required />
        </div>

        <div class="field">
          <label for="description">Descrição (o que inclui, metas, formato das aulas)</label>
          <textarea id="description" name="description" class="pm-textarea" rows="6" maxlength="1200" required></textarea>
        </div>

        <div class="field">
          <label for="video-url">Link de vídeo / portfólio (YouTube, Twitch, etc.)</label>
          <input id="video-url" name="video" class="pm-input" type="url" placeholder="https://" />
        </div>

        <div class="field">
          <label for="thumbnail">Imagem de capa (opcional)</label>
          <input id="thumbnail" name="thumbnail" class="pm-input" type="file" accept="image/*" />
        </div>

        <div class="field">
          <label for="available-times">Horários disponíveis (texto livre ou link para agenda)</label>
          <input id="available-times" name="availability" class="pm-input" placeholder="Seg/Qua 19:00 - 22:00, Link Calendly..." />
        </div>

        <div class="field">
          <label for="contact">Contato (Discord / WhatsApp / e-mail)</label>
          <input id="contact" name="contact" class="pm-input" required />
        </div>

        <div class="form-actions">
          <button type="submit" id="submit-listing" class="pm-btn-primary">Publicar anúncio</button>
          <span id="listing-feedback" role="status" aria-live="polite"></span>
        </div>
      </form>

      <p class="pm-note">Ao publicar, o anúncio passará por moderação antes de aparecer publicamente (recomendado).</p>
    </section>

    <!-- Modal simples para ver detalhes -->
    <div id="modal" class="pm-modal" aria-hidden="true">
      <div class="pm-modal-dialog" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <button id="modal-close" class="pm-modal-close" aria-label="Fechar">×</button>
        <div id="modal-content"></div>
      </div>
    </div>
  </main>

  <script>
    // ======= Observação ========
    // Este script é uma base front-end e NÃO contém integração com pagamentos.
    // Substitua as URLs /api/... pelos endpoints do seu backend.

    (function(){
      const listingsEl = document.getElementById('listings');
      const form = document.getElementById('listing-form');
      const feedback = document.getElementById('listing-feedback');
      const searchInput = document.getElementById('search-input');
      const filterGame = document.getElementById('filter-game');
      const filterType = document.getElementById('filter-type');
      const clearFiltersBtn = document.getElementById('btn-clear-filters');

      // Mock local listing store para demo (substituir por chamada real ao backend)
      let listings = [
        // Exemplo
        {
          id: 'ex1',
          name: 'Vitor#1234',
          title: 'Aulas de VGC — Estratégia e Team Preview',
          game: 'pokemon',
          type: 'aula',
          price: 80.00,
          currency: 'BRL',
          duration: 60,
          description: 'Aulas práticas ao vivo, análise de replays e treinos direcionados.',
          contact: 'discord.gg/vitor',
          thumbnail: '',
          rating: 4.9
        }
      ];

      function formatPrice(p, cur){
        try{ return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: cur || 'BRL' }).format(p); }
        catch(e){ return (p == null) ? '-' : (p + ' ' + (cur || 'BRL')); }
      }

      function renderListings(items){
        listingsEl.innerHTML = '';
        if(!items.length){
          listingsEl.innerHTML = '<p class="pm-empty">Nenhum anúncio encontrado.</p>';
          return;
        }

        const ul = document.createElement('ul');
        ul.className = 'pm-list';

        items.forEach(item => {
          const li = document.createElement('li');
          li.className = 'pm-list-item';

          li.innerHTML = `
            <article class="pm-card" data-id="${item.id}">
              <div class="pm-card-thumb">${item.thumbnail ? '<img src="'+item.thumbnail+'" alt="Capa"/>' : ''}</div>
              <div class="pm-card-body">
                <h3 class="pm-card-title">${escapeHtml(item.title)}</h3>
                <p class="pm-card-meta">${escapeHtml(item.name)} • ${escapeHtml(item.game)} • ${escapeHtml(item.type)}</p>
                <p class="pm-card-desc">${escapeHtml(truncate(item.description, 140))}</p>
                <p class="pm-card-price">${formatPrice(item.price, item.currency)} • ${item.duration} min</p>
                <div class="pm-card-actions">
                  <button class="pm-btn pm-btn-sm" data-action="view" data-id="${item.id}">Ver</button>
                  <a class="pm-btn pm-btn-sm pm-btn-outline" href="mailto:${encodeURIComponent(item.contact)}">Contato</a>
                </div>
              </div>
            </article>
          `;

          ul.appendChild(li);
        });

        listingsEl.appendChild(ul);
      }

      function escapeHtml(text){
        if(!text) return '';
        return String(text)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
      }

      function truncate(text, n){ return text && text.length > n ? text.slice(0,n-1) + '…' : (text||''); }

      // Inicial render
      renderListings(listings);

      // Filtros simples
      function applyFilters(){
        const q = searchInput.value.trim().toLowerCase();
        const g = filterGame.value;
        const t = filterType.value;

        const filtered = listings.filter(l => {
          if(g && l.game !== g) return false;
          if(t && l.type !== t) return false;
          if(q){
            return [l.title, l.name, l.description, l.game, l.type].some(field => (field||'').toLowerCase().includes(q));
          }
          return true;
        });

        renderListings(filtered);
      }

      searchInput.addEventListener('input', applyFilters);
      filterGame.addEventListener('change', applyFilters);
      filterType.addEventListener('change', applyFilters);
      clearFiltersBtn.addEventListener('click', ()=>{
        searchInput.value = '';
        filterGame.value = '';
        filterType.value = '';
        applyFilters();
      });

      // Evento de ver anúncio (delegation)
      listingsEl.addEventListener('click', (ev)=>{
        const btn = ev.target.closest('button[data-action="view"]');
        if(!btn) return;
        const id = btn.dataset.id;
        const item = listings.find(x => x.id === id);
        if(item) openModal(item);
      });

      function openModal(item){
        const modal = document.getElementById('modal');
        const content = document.getElementById('modal-content');
        modal.setAttribute('aria-hidden', 'false');
        content.innerHTML = `
          <h2 id="modal-title">${escapeHtml(item.title)}</h2>
          <p><strong>Coach:</strong> ${escapeHtml(item.name)}</p>
          <p><strong>Jogo:</strong> ${escapeHtml(item.game)}</p>
          <p><strong>Tipo:</strong> ${escapeHtml(item.type)}</p>
          <p><strong>Preço:</strong> ${formatPrice(item.price, item.currency)}</p>
          <p>${escapeHtml(item.description)}</p>
          <p><strong>Contato:</strong> ${escapeHtml(item.contact)}</p>
        `;

        document.getElementById('modal-close').focus();
      }

      document.getElementById('modal-close').addEventListener('click', ()=>{
        const modal = document.getElementById('modal');
        modal.setAttribute('aria-hidden', 'true');
        document.getElementById('modal-content').innerHTML = '';
      });

      // Form submit — cria objeto e envia para backend
      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        feedback.textContent = '';

        // Validação simples
        const data = new FormData(form);
        const json = {};
        for(const [k,v] of data.entries()){
          json[k] = v;
        }

        // Transformar preço/duration
        json.price = parseFloat(json.price || 0);
        json.duration = parseInt(json.duration || 0, 10);

        // Subir imagem (se houver) — aqui enviamos ao endpoint /api/upload que deve retornar {url}
        if(data.get('thumbnail') && data.get('thumbnail').name){
          try{
            // Exemplo: envie a imagem para seu endpoint de upload
            // const uploadResp = await fetch('/api/upload', { method: 'POST', body: new FormData(form) });
            // const uploadJson = await uploadResp.json();
            // json.thumbnail = uploadJson.url;

            // Para demo, vamos usar uma imagem placeholder
            json.thumbnail = '';
          }catch(err){
            console.error(err);
            feedback.textContent = 'Falha ao enviar imagem.';
            return;
          }
        }

        // Enviar ao backend para criar o anúncio
        try{
          // Substitua por sua API real
          // const resp = await fetch('/api/coach/create', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(json) });
          // const result = await resp.json();

          // Demo: simular id e adicionar localmente
          json.id = 'c'+(Date.now());
          listings.unshift(json);
          renderListings(listings);

          feedback.textContent = 'Anúncio enviado para moderação.';
          form.reset();
        }catch(err){
          console.error(err);
          feedback.textContent = 'Erro ao publicar anúncio.';
        }

      });

      // === Sugestões de integração (nã o-visual) ===
      // 1) Endpoint POST /api/coach/create -> cria o anúncio no banco com status: pending
      // 2) Endpoint GET  /api/coach/list   -> retorna lista de anúncios aprovados com paginação
      // 3) Endpoint POST /api/upload       -> recebe multipart/form-data e retorna { url: 'https://...' }
      // 4) Pagamentos/Agendamento: Integre Stripe Checkout / Checkout Session (ou PagSeguro/Pagar.me) para processar pagamentos;
      //    ou direcione para agendamento (Calendly, Google Calendar, etc.).

    })();
  </script>
</body>
</html>
