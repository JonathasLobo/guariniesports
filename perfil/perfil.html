<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Perfil do usu√°rio - Guarini e-sport">
  <title>Meu Perfil - Guarini e-sport</title>
  <link rel="icon" href="favicon.png" type="image/png">
  <link rel="stylesheet" href="../style.css">
  <link rel="stylesheet" href="perfil.css">
  <meta name="theme-color" content="#ffad00">
</head>

<body>
  <a id="topo"></a>

  <header>
    <div class="header-wrapper">
      <!-- Navega√ß√£o Desktop - Esquerda -->
      <nav class="nav-group left-nav">
        <ul>
          <li><a href="../loja/loja.html">Shop</a></li>
          <li><a href="../sobre/sobre.html">√Åbout</a></li>
        </ul>
      </nav>
      
      <!-- Logo Central -->
      <div class="logo-center">
        <a href="../index.html" aria-label="In√≠cio">
          <img src="../img-site/grn-logo.png" alt="Guarini e-sport" class="header-logo">
        </a>
      </div>

      <!-- Navega√ß√£o Desktop - Direita -->
      <nav class="nav-group right-nav">
        <ul>
          <li><a href="../groups/groups.html">Games</a></li>
          <li><a href="../contato/contato.html">Contact</a></li>
        </ul>
      </nav>
      
    </div>
  </header>

  <!-- Menu dropdown do usu√°rio -->
  <div class="user-menu-container">
    <button class="user-menu-toggle" id="userMenuToggle" aria-label="Menu do usu√°rio">
      <span></span>
      <span></span>
      <span></span>
    </button>
    
    <div class="user-dropdown" id="userDropdown">
      <div class="user-dropdown-header" id="userDropdownHeader">
        <span>Hello, visitor!</span>
      </div>
      <ul class="user-dropdown-list">
        <li><a href="./perfil.html" id="perfilLink">Profile</a></li>
        <li><a href="../loja/loja.html">Shop</a></li>
        <li><a href="../sobre/sobre.html">About</a></li>
        <li><a href="../groups/groups.html">Games</a></li>
        <li><a href="../contato/contato.html">Contact</a></li>
        <li><a href="#" id="authLink">Login</a></li>
      </ul>
    </div>
  </div>

   <div class="profile-search-container">
    <div class="profile-search-wrapper">
      <input 
        type="text" 
        id="profileSearchInput" 
        class="profile-search-input" 
        placeholder="Search Player ID..."
        maxlength="7"
      >
      <button class="profile-search-btn" id="profileSearchBtn" title="Search Profile">
        üîç
      </button>
    </div>
    <div class="profile-search-results" id="profileSearchResults"></div>
  </div>

  <main>
    <section class="perfil-section">
      <h2>Profile</h2>
      
      <!-- Card de Perfil -->
      <div class="perfil-card">
        <!-- Foto de Perfil -->
        <div class="perfil-avatar-container">
          <div class="perfil-avatar" id="perfilAvatar">
            <img src="../estatisticas-shad/images/backgrounds/pikachu-left-bg.png" alt="Avatar do usu√°rio" id="avatarImg">
          </div>
        </div>

        <!-- Informa√ß√µes do Usu√°rio -->
        <div class="perfil-info">
          <div class="perfil-nome-container">
            <h3 id="perfilNomeDisplay">User name</h3>
            <button class="btn-edit-nome" id="btnEditNome" title="Editar nome">
              ‚úèÔ∏è
            </button>
          </div>
          <input type="text" id="perfilNomeInput" class="perfil-nome-input" style="display: none;" maxlength="30">
          <p class="perfil-email" id="perfilEmail">usuario@email.com</p>
          <!-- Player ID Section -->
          <div class="perfil-player-id-container">
            <p class="perfil-player-id-label">Unite ID:</p>
            
            <!-- Exibi√ß√£o do ID (quando j√° cadastrado) -->
            <p class="perfil-player-id-display" id="playerIdDisplay" style="display: none;">-</p>
            
            <!-- Input para cadastrar ID (quando n√£o tem ID) -->
            <div class="perfil-player-id-input-group" id="playerIdInputGroup" style="display: none;">
              <input 
                type="text" 
                id="playerIdInput" 
                class="perfil-player-id-input" 
                placeholder="Ex: A1B2C or A1B2C3D"
                maxlength="7"
                pattern="[A-Za-z0-9]{5,7}"
              >
              <button class="btn-save-player-id" id="btnSavePlayerId">
                üíæ Save
              </button>
              <button class="btn-help-player-id" id="btnHelpPlayerId" title="Help">
                ?
              </button>
            </div>
          </div>

          <!-- Share Profile Section -->
          <div class="perfil-share-container">
            <p class="perfil-share-label">Share Profile:</p>
            <button class="btn-share-profile" id="btnShareProfile" title="Copy profile link">
              üîó Copy Link
            </button>
            <span class="share-feedback" id="shareFeedback" style="display: none;">‚úÖ Copied!</span>
          </div>

          <!-- Modal de Ajuda -->
          <div class="modal-help-overlay" id="modalHelpPlayerId">
            <div class="modal-help-content">
              <button class="modal-help-close" id="btnCloseHelpModal">‚úï</button>
              <h3>üìã How to find your Player ID</h3>
              <p>
                <strong>Step 1:</strong> Open Pok√©mon UNITE on your device<br><br>
                <strong>Step 2:</strong> Go to your profile (tap your trainer card)<br><br>
                <strong>Step 3:</strong> Look for your <strong>Player ID</strong> (it's a 7-character code with letters and numbers)<br><br>
                <strong>Step 4:</strong> Copy this ID and paste it here<br><br>
                ‚ö†Ô∏è <strong>Important:</strong> This ID can only be set once and cannot be changed later. Make sure you enter the correct ID!
              </p>
            </div>
          </div>
        </div>
          <!-- √öltimas Visualiza√ß√µes -->
          <div class="perfil-recent-views" id="recentViewsSection">
            <h4>Last Views</h4>
            <div class="recent-views-list" id="recentViewsList">
              <div class="no-recent-views">No recent views yet</div>
            </div>
          </div>
      </div>  

      <!-- √Årea para builds salvas -->
      <section class="perfil-section">
        <h2>Saved Builds</h2>
        
        <div class="perfil-content">
          <div id="builds-container-perfil" class="builds-container">
            <div class="builds-loading">
              Working...
            </div>
          </div>
        </div>
      </section>

      <!-- √Érea para Battle Ribbons List -->
      <section class="perfil-section">
        <h2>Battle Ribbons List</h2>
        
        <div class="perfil-content">
          <!-- Gold Ribbon -->
          <div class="ribbon-tier">
            <div class="ribbon-icon-container">
              <img src="../estatisticas-shad/images/icons/dourado.png" alt="Gold Ribbon" class="ribbon-icon">
            </div>
            <div class="ribbon-pokemon-list" id="goldRibbonList" data-tier="gold">
              <button class="btn-add-pokemon" data-tier="gold">+</button>
            </div>
          </div>

          <!-- Blue Ribbon -->
          <div class="ribbon-tier">
            <div class="ribbon-icon-container">
              <img src="../estatisticas-shad/images/icons/azul.png" alt="Blue Ribbon" class="ribbon-icon">
            </div>
            <div class="ribbon-pokemon-list" id="blueRibbonList" data-tier="blue">
              <button class="btn-add-pokemon" data-tier="blue">+</button>
            </div>
          </div>

          <!-- Green Ribbon -->
          <div class="ribbon-tier">
            <div class="ribbon-icon-container">
              <img src="../estatisticas-shad/images/icons/verde.png" alt="Green Ribbon" class="ribbon-icon">
            </div>
            <div class="ribbon-pokemon-list" id="greenRibbonList" data-tier="green">
              <button class="btn-add-pokemon" data-tier="green">+</button>
            </div>
          </div>

          <!-- Bot√µes de A√ß√£o -->
          <div class="ribbon-actions">
            <button class="btn-ribbon-action btn-save-ribbons" id="btnSaveRibbons">
              üíæ Save List
            </button>
          </div>
        </div>
      </section>

      <!-- Modal de Sele√ß√£o de Pok√©mon para Ribbons -->
  <div class="modal-overlay" id="modalRibbonPokemon">
    <div class="modal-content modal-ribbon-content">
      <div class="modal-header">
        <h3>Select Pok√©mon</h3>
        <button class="modal-close" id="btnCloseRibbonModal">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="ribbon-pokemon-grid" id="ribbonPokemonGrid">
          <!-- Pok√©mons ser√£o carregados aqui -->
        </div>
      </div>
    </div>
  </div>
  </main>

  <!-- Modal de Sele√ß√£o de Avatar -->
  <div class="modal-overlay" id="modalAvatar">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Choose your avatar!</h3>
        <button class="modal-close" id="btnCloseModal">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="avatar-grid" id="avatarGrid">
          <!-- As imagens ser√£o carregadas aqui dinamicamente -->
        </div>
      </div>
    </div>
  </div>

  <footer>
    <div class="footer-info">
        <p>&copy; ¬© 2019 Guarin√≠ E-sport. All rights reserved.</p>
        <p><a href="https://linktr.ee/guariniesports" target="_blank">Follow us on social media!</a></p>
        <p>Created by: Lobo & Shad</p>
      </div>
    </div>
  </footer>
  <script src="../estatisticas-shad/util.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { 
    getAuth, 
    onAuthStateChanged, 
    signOut,
    updateProfile
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import { 
  getFirestore, 
  doc, 
  getDoc,
  collection, 
  query, 
  where, 
  getDocs,
  setDoc,      // ‚Üê Adicione estas 3
  updateDoc,   // ‚Üê Adicione estas 3
  deleteDoc    // ‚Üê Adicione estas 3 (voc√™ usa no excluirBuild)
} from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

  // Importar fun√ß√µes do perfil.js
  import { initRibbons } from './perfil.js';
  
  // ‚≠ê Importar sistema de avalia√ß√£o
  import { createRatingViewOnly } from './build-rating.js';
  
  // Expor para uso global
  window.createRatingViewOnly = createRatingViewOnly;
  const firebaseConfig = {
    apiKey: "AIzaSyC9LLCXrQTHBagQxaChBazSfS5E4gUPIoI",
    authDomain: "site-grn.firebaseapp.com",
    projectId: "site-grn",
    storageBucket: "site-grn.firebasestorage.app",
    messagingSenderId: "27613322806",
    appId: "1:27613322806:web:ad4dc08ce043f19d530297",
    measurementId: "G-84NHN394WF"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore();

  // ========================================
  // ELEMENTOS DO DOM - BUSCA DE PERFIL
  // ========================================
  const profileSearchBtn = document.getElementById('profileSearchBtn');
  const profileSearchInput = document.getElementById('profileSearchInput');
  const profileSearchResults = document.getElementById('profileSearchResults');

  // ========================================
  // BUSCA DE PERFIL - COM BUSCA AUTOM√ÅTICA
  // ========================================

  // Fun√ß√£o para buscar perfil
  async function buscarPerfil() {
    const playerId = profileSearchInput.value.trim().toUpperCase();
    
    if (!playerId) {
      profileSearchResults.classList.remove('show');
      return;
    }
    
    if (playerId.length !== 7) {
      profileSearchResults.classList.remove('show');
      return;
    }
    
    try {
      profileSearchResults.innerHTML = '<div class="profile-search-no-results">üîç Searching...</div>';
      profileSearchResults.classList.add('show');
      
      console.log('üîç Buscando Player ID:', playerId);
      
      const usuariosRef = collection(db, "usuarios");
      const q = query(usuariosRef, where("playerId", "==", playerId));
      
      console.log('üì° Query criada, executando busca...');
      
      const querySnapshot = await getDocs(q);
      
      console.log('üì¶ Resultado da busca:', {
        empty: querySnapshot.empty,
        size: querySnapshot.size
      });
      
      if (querySnapshot.empty) {
        console.log('‚ùå Nenhum usu√°rio encontrado com Player ID:', playerId);
        profileSearchResults.innerHTML = '<div class="profile-search-no-results">‚ùå Player not found</div>';
        return;
      }
      
      const userDoc = querySnapshot.docs[0];
      const userData = userDoc.data();
      const userId = userDoc.id;
      
      console.log('‚úÖ Usu√°rio encontrado:', {
        userId: userId,
        playerId: userData.playerId,
        displayName: userData.displayName,
        email: userData.email
      });
      
      profileSearchResults.innerHTML = `
        <div class="profile-search-result-item" style="background: rgba(255, 173, 0, 0.1); cursor: default;">
          <div style="flex: 1;">
            <div style="color: #ffad00; font-weight: bold; margin-bottom: 5px;">
              ‚úÖ Player found!
            </div>
            <div style="color: #fff; font-size: 13px;">
              ${userData.displayName || 'Anonymous'}
            </div>
            <div style="color: #aaa; font-size: 11px; margin-top: 3px;">
              ID: ${userData.playerId}
            </div>
          </div>
        </div>
        <div style="margin-top: 10px; text-align: center;">
          <button 
            onclick="window.location.href='perfil-view.html?uid=${userId}'" 
            style="background: linear-gradient(45deg, #ff7500, #ffad00); border: none; padding: 10px 20px; border-radius: 8px; color: #000; font-weight: bold; cursor: pointer; transition: all 0.3s ease;"
            onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 5px 15px rgba(255, 173, 0, 0.5)'"
            onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'"
          >
            üë§ View Profile
          </button>
        </div>
      `;
      
    } catch (error) {
      console.error('‚ùå Erro ao buscar perfil:', error);
      console.error('Detalhes do erro:', {
        message: error.message,
        code: error.code,
        stack: error.stack
      });
      
      profileSearchResults.innerHTML = `
        <div class="profile-search-no-results" style="color: #ff6b6b;">
          ‚ùå Search error<br>
          <small style="font-size: 11px; color: #aaa; margin-top: 5px; display: block;">
            ${error.message}
          </small>
        </div>
      `;
    }
  }

  // Toggle da barra de busca
  profileSearchBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    console.log('üñ±Ô∏è Bot√£o de busca clicado');
    profileSearchInput.classList.toggle('active');
    
    if (profileSearchInput.classList.contains('active')) {
      console.log('‚úÖ Input ativado');
      profileSearchInput.focus();
    } else {
      console.log('‚ùå Input desativado');
      profileSearchInput.value = '';
      profileSearchResults.classList.remove('show');
    }
  });

  // Buscar ao pressionar Enter
  profileSearchInput.addEventListener('keypress', async (e) => {
    if (e.key === 'Enter') {
      console.log('‚å®Ô∏è Enter pressionado');
      await buscarPerfil();
    }
  });

  // Valida√ß√£o e busca autom√°tica ao digitar 7 caracteres
  profileSearchInput.addEventListener('input', async (e) => {
    e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
    if (e.target.value.length > 7) {
      e.target.value = e.target.value.slice(0, 7);
    }
    
    if (e.target.value.length === 7) {
      console.log('üéØ 7 caracteres digitados - buscando automaticamente...');
      await buscarPerfil();
    } else {
      profileSearchResults.classList.remove('show');
    }
  });

  // Fechar ao clicar fora
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.profile-search-container')) {
      profileSearchInput.classList.remove('active');
      profileSearchResults.classList.remove('show');
    }
  });
  // ===== FUN√á√ïES DE BUILDS =====
  
  // Fun√ß√£o auxiliar para capitalizar primeira letra
  function capitalizeFirst(str) {
    if (!str) return '';
    return str.charAt(0).toUpperCase() + str.slice(1);
  }

  // Fun√ß√£o para editar build (redireciona para calculadora)
  function editarBuild(buildId) {
    localStorage.setItem('loadBuildId', buildId);
    window.location.href = '../damage-calculator.html';
  }

  // Fun√ß√£o para excluir build
  async function excluirBuild(buildId, userId) {
    const confirmacao = confirm('Tem certeza que deseja excluir esta build? Esta a√ß√£o n√£o pode ser desfeita.');
    
    if (!confirmacao) return;
    
    try {
      const buildRef = doc(db, "usuarios", userId, "builds", buildId);
      await deleteDoc(buildRef);
      
      console.log('‚úÖ Build deletada:', buildId);
      alert('‚úÖ Build exclu√≠da com sucesso!');
      
      // Recarregar lista de builds
      await carregarBuildsUsuario(userId);
      
    } catch (error) {
      console.error('‚ùå Erro ao excluir build:', error);
      alert(`‚ùå Erro ao excluir build: ${error.message}`);
    }
  }

 // ===== FUN√á√ïES AUXILIARES PARA PROCESSAR DADOS DO FIREBASE =====

/**
 * Converte selectedSkills do Firebase para formato do card
 * @param {Object} selectedSkills - { s1: "s11", s2: "s12" }
 * @returns {Object} - { skill1: { name, key }, skill2: { name, key } }
 */
function processSkillsFromFirebase(selectedSkills) {
  if (!selectedSkills) return { skill1: null, skill2: null };
  
  const result = {};
  
  // Processar skill 1
  if (selectedSkills.s1 && selectedSkills.s1 !== 'none') {
    const skillKey = selectedSkills.s1; // ex: "s11"
    result.skill1 = {
      key: skillKey,
      name: formatSkillName(skillKey)
    };
  } else {
    result.skill1 = null;
  }
  
  // Processar skill 2
  if (selectedSkills.s2 && selectedSkills.s2 !== 'none') {
    const skillKey = selectedSkills.s2; // ex: "s12"
    result.skill2 = {
      key: skillKey,
      name: formatSkillName(skillKey)
    };
  } else {
    result.skill2 = null;
  }
  
  return result;
}

/**
 * Formata nome da skill baseado na key
 */
function formatSkillName(skillKey) {
  if (!skillKey) return 'Unknown';
  const num = skillKey.replace('s', '');
  return `Skill ${num}`;
}

/**
 * Converte selectedEmblems do Firebase para formato do card
 * @param {Object} selectedEmblems - { brown: "6", red: "7", white: "6" }
 * @returns {Object} - { emblem1: { color, level }, emblem2: {...}, emblem3: {...}, emblem4: {...} }
 */
function processEmblemsFromFirebase(selectedEmblems) {
  if (!selectedEmblems) return { emblem1: null, emblem2: null, emblem3: null, emblem4: null };
  
  const result = {};
  const colors = ['brown', 'red', 'white', 'black', 'blue', 'yellow', 'green', 'purple', 'pink', 'gray', 'navy'];
  
  // Converter objeto em array de emblems v√°lidos
  const emblems = [];
  colors.forEach(color => {
    if (selectedEmblems[color] && selectedEmblems[color] !== 'none' && selectedEmblems[color] !== '0') {
      emblems.push({
        color: color,
        level: parseInt(selectedEmblems[color]) || 0
      });
    }
  });
  
  // Atribuir aos slots (m√°ximo 4)
  result.emblem1 = emblems[0] || null;
  result.emblem2 = emblems[1] || null;
  result.emblem3 = emblems[2] || null;
  result.emblem4 = emblems[3] || null;
  
  return result;
}

// ===== FUN√á√ÉO createBuildCard ATUALIZADA =====

// ===== FUN√á√ÉO createBuildCard CORRIGIDA =====

function createBuildCard(build) {
  console.log('üé® Criando card para build:', build);
  
  const pokemonImage = build.pokemon ? 
    `../estatisticas-shad/images/backgrounds/${build.pokemon}-left-bg.png` : 
    '../estatisticas-shad/images/backgrounds/placeholder.png';
  
  const pokemonName = capitalizeFirst(build.pokemon);
  const roleInfo = getPokemonRole(build.pokemon);
  
  // Battle Item
  const battleItemHTML = build.battleItem ? `
    <div class="build-item-circle">
      <img src="../estatisticas-shad/images/battle-items/${build.battleItem}.png" 
           alt="Battle Item"
           onerror="this.style.display='none'">
    </div>
  ` : '';
  
  // Held Items (m√°ximo 3)
  const heldItemsHTML = build.heldItems && build.heldItems.length > 0 ? 
    build.heldItems.slice(0, 3).map(item => `
      <div class="build-item-circle">
        <img src="../estatisticas-shad/images/held-itens/${item.key}.png" 
             alt="${item.name}"
             title="${item.name}${item.stacks > 0 ? ` (${item.stacks} stacks)` : ''}"
             onerror="this.style.display='none'">
      </div>
    `).join('') : 
    '<span style="color: #888; font-size: 10px;">No items</span>';
  
  // Processar skills
  const processedSkills = processSkillsFromFirebase(build.selectedSkills);
  
  const skillsHTML = [];
  for (let i = 1; i <= 2; i++) {
    const skill = processedSkills[`skill${i}`];
    
    if (skill && skill.key) {
      const skillImagePath = `../estatisticas-shad/images/skills/${build.pokemon}_${skill.key}.png`;
      
      skillsHTML.push(`
        <div class="build-skill-circle" title="${skill.name}">
          <img src="${skillImagePath}" 
               alt="${skill.name}"
               onerror="console.warn('‚ùå Skill image not found:', '${skillImagePath}'); this.parentElement.classList.add('empty'); this.style.display='none'">
        </div>
      `);
    } else {
      skillsHTML.push(`
        <div class="build-skill-circle empty" title="No skill selected"></div>
      `);
    }
  }
  
  // Processar emblems
  const processedEmblems = processEmblemsFromFirebase(build.selectedEmblems);

  const emblemsHTML = [];
  for (let i = 1; i <= 4; i++) {
    const emblem = processedEmblems[`emblem${i}`];
    
    if (emblem && emblem.color) {
      const level = emblem.level || 0;
      const colorName = capitalizeFirst(emblem.color);
      
      emblemsHTML.push(`
        <div class="build-emblem-item">
          <div class="build-emblem-color" 
               title="${colorName} Emblem - Level ${level}">
            <img src="../estatisticas-shad/images/icons/${emblem.color}.png" 
                 alt="${colorName}"
                 style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;"
                 onerror="this.style.display='none'; this.parentElement.classList.add('emblem-${emblem.color}')">
          </div>
          <div class="build-emblem-level">Lv.${level}</div>
        </div>
      `);
    } else {
      emblemsHTML.push(`
        <div class="build-emblem-item">
          <div class="build-emblem-color empty" title="No emblem"></div>
          <div class="build-emblem-level empty">-</div>
        </div>
      `);
    }
  }

  // ‚≠ê Criar HTML de avalia√ß√£o (view-only para o pr√≥prio perfil)
  const ratingHTML = window.createRatingViewOnly ? 
    window.createRatingViewOnly(build.id, build.ratings) : 
    '';

  // ‚≠ê RETORNAR COM WRAPPER .build-with-rating
  return `
    <div class="build-with-rating">
      ${ratingHTML}
      
      <div class="build-card-perfil" data-build-id="${build.id}">
        <div class="build-pokemon-image">
          <img src="${pokemonImage}" 
               alt="${pokemonName}"
               onerror="this.src='../estatisticas-shad/images/backgrounds/placeholder.png'">
        </div>
        
        <h3 class="build-pokemon-name">${pokemonName}</h3>
        
        ${roleInfo ? `
          <div class="build-pokemon-role">
            <img src="../estatisticas-shad/images/roles/${roleInfo.icon}.png" 
                 alt="${roleInfo.name}"
                 onerror="this.style.display='none'">
            <span>${roleInfo.name}</span>
          </div>
        ` : ''}
        
        <div class="build-details">
          <p class="build-name-header">${build.buildName}</p>
          
          <div class="build-items-section">
            ${battleItemHTML ? `
              <div class="build-battle-item">
                ${battleItemHTML}
              </div>
            ` : ''}
            
            <div class="build-held-items">
              ${heldItemsHTML}
            </div>
          </div>
          
          <div class="build-skills-section">
            ${skillsHTML.join('')}
          </div>
          
          <div class="build-emblems-section">
            ${emblemsHTML.join('')}
          </div>
          
          <div class="build-actions-perfil">
            <button class="btn-build-action-perfil btn-edit-perfil" data-build-id="${build.id}">
              ‚úèÔ∏è Edit
            </button>
            <button class="btn-build-action-perfil btn-delete-perfil" data-build-id="${build.id}">
              üóëÔ∏è Delete
            </button>
          </div>
        </div>
      </div>
    </div>
  `;
}

// Fun√ß√£o auxiliar para obter role do Pok√©mon
function getPokemonRole(pokemonKey) {
  return null;
}

  // Fun√ß√£o para carregar e exibir as builds do usu√°rio
  async function carregarBuildsUsuario(userId) {
    const buildsContainer = document.getElementById('builds-container-perfil');
    
    if (!buildsContainer) {
      console.error('‚ùå Container de builds n√£o encontrado');
      return;
    }
    
    try {
      buildsContainer.innerHTML = '<div class="builds-loading">Carregando builds...</div>';
      
      console.log('üîÑ Carregando builds do usu√°rio:', userId);
      
      // Buscar builds do usu√°rio
      const buildsRef = collection(db, "usuarios", userId, "builds");
      const buildsSnap = await getDocs(buildsRef);
      
      console.log('üì¶ Builds encontradas:', buildsSnap.size);
      
      if (buildsSnap.empty) {
        buildsContainer.innerHTML = `
          <div class="no-builds-message">
            Nenhuma build salva ainda.<br>
            Crie sua primeira build na calculadora!
          </div>
        `;
        return;
      }
      
      // Processar builds
      const builds = [];
      buildsSnap.forEach(docSnap => {
        builds.push({ id: docSnap.id, ...docSnap.data() });
      });
      
      // Ordenar por data de atualiza√ß√£o (mais recente primeiro)
      builds.sort((a, b) => {
        const dateA = a.updatedAt?.toDate() || new Date(0);
        const dateB = b.updatedAt?.toDate() || new Date(0);
        return dateB - dateA;
      });
      
      // Renderizar builds
      buildsContainer.innerHTML = builds.map(build => createBuildCard(build)).join('');
      
      // Adicionar event listeners
      const editButtons = buildsContainer.querySelectorAll('.btn-edit-perfil');
      const deleteButtons = buildsContainer.querySelectorAll('.btn-delete-perfil');
      
      editButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const buildId = btn.getAttribute('data-build-id');
          editarBuild(buildId);
        });
      });
      
      deleteButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const buildId = btn.getAttribute('data-build-id');
          excluirBuild(buildId, userId);
        });
      });
      
      console.log('‚úÖ Builds carregadas com sucesso!');
      
    } catch (error) {
      console.error('‚ùå Erro ao carregar builds:', error);
      buildsContainer.innerHTML = `
        <div class="no-builds-message" style="color: #ff6b6b;">
          ‚ùå Erro ao carregar builds: ${error.message}
        </div>
      `;
    }
  }
  // ========================================
  // SISTEMA DE √öLTIMAS VISUALIZA√á√ïES
  // ========================================

  // Fun√ß√£o para carregar √∫ltimas visualiza√ß√µes
  async function carregarUltimasVisualizacoes(userId) {
    try {
      console.log('üëÅÔ∏è Carregando √∫ltimas visualiza√ß√µes...');
      
      const userDocRef = doc(db, "usuarios", userId);
      const userDocSnap = await getDoc(userDocRef);
      
      const recentViewsSection = document.getElementById('recentViewsSection');
      const recentViewsList = document.getElementById('recentViewsList');
      
      if (!userDocSnap.exists() || !userDocSnap.data().profileViews) {
        console.log('‚ÑπÔ∏è Nenhuma visualiza√ß√£o ainda');
        recentViewsList.innerHTML = '<div class="no-recent-views">No views yet</div>';
        recentViewsSection.style.display = 'block'; // ‚Üê MUDAN√áA AQUI
        return;
      }
      
      const profileViews = userDocSnap.data().profileViews;
      
      // Ordenar por timestamp (mais recente primeiro)
      const sortedViews = profileViews
        .sort((a, b) => b.timestamp?.toMillis() - a.timestamp?.toMillis())
        .slice(0, 2); // Pegar apenas as 2 mais recentes
      
      if (sortedViews.length === 0) {
        console.log('‚ÑπÔ∏è Lista de visualiza√ß√µes vazia');
        recentViewsList.innerHTML = '<div class="no-recent-views">No views yet</div>';
        recentViewsSection.style.display = 'block'; // ‚Üê MUDAN√áA AQUI
        return;
      }
      
      console.log('‚úÖ Visualiza√ß√µes encontradas:', sortedViews.length);
      
      // Buscar dados dos usu√°rios que visualizaram
      const viewsWithData = await Promise.all(
        sortedViews.map(async (view) => {
          try {
            const viewerDocRef = doc(db, "usuarios", view.viewerId);
            const viewerDocSnap = await getDoc(viewerDocRef);
            
            if (viewerDocSnap.exists()) {
              const viewerData = viewerDocSnap.data();
              return {
                ...view,
                displayName: viewerData.displayName || 'Anonymous',
                playerId: viewerData.playerId || 'N/A',
                avatar: viewerData.avatar || '../estatisticas-shad/images/backgrounds/pikachu-left-bg.png'
              };
            }
            return null;
          } catch (error) {
            console.error('Erro ao buscar dados do viewer:', error);
            return null;
          }
        })
      );
      
      // Filtrar views com dados v√°lidos
      const validViews = viewsWithData.filter(v => v !== null);
      
      if (validViews.length === 0) {
        recentViewsList.innerHTML = '<div class="no-recent-views">No views yet</div>';
        recentViewsSection.style.display = 'block'; // ‚Üê MUDAN√áA AQUI
        return;
      }
      
      // Renderizar lista
      recentViewsList.innerHTML = validViews.map(view => {
        const timeAgo = formatarTempoAtras(view.timestamp?.toDate());
        
        return `
          <div class="recent-view-item" onclick="window.location.href='perfil-view.html?uid=${view.viewerId}'">
            <div class="recent-view-avatar">
              <img src="${view.avatar}" alt="${view.displayName}" onerror="this.src='../estatisticas-shad/images/backgrounds/pikachu-left-bg.png'">
            </div>
            <div class="recent-view-info">
              <p class="recent-view-name">${view.displayName}</p>
              <p class="recent-view-id">ID: ${view.playerId}</p>
            </div>
            <div class="recent-view-time">${timeAgo}</div>
          </div>
        `;
      }).join('');
      
      // Mostrar se√ß√£o
      recentViewsSection.style.display = 'block';
      
      console.log('‚úÖ √öltimas visualiza√ß√µes renderizadas');
      
    } catch (error) {
      console.error('‚ùå Erro ao carregar visualiza√ß√µes:', error);
      const recentViewsSection = document.getElementById('recentViewsSection');
      recentViewsSection.style.display = 'none';
    }
  }

  // Fun√ß√£o auxiliar para formatar tempo atr√°s
  function formatarTempoAtras(date) {
    if (!date) return 'Recently';
    
    const agora = new Date();
    const diff = agora - date;
    
    const minutos = Math.floor(diff / 60000);
    const horas = Math.floor(diff / 3600000);
    const dias = Math.floor(diff / 86400000);
    
    if (minutos < 1) return 'Just now';
    if (minutos < 60) return `${minutos}m ago`;
    if (horas < 24) return `${horas}h ago`;
    if (dias < 7) return `${dias}d ago`;
    return date.toLocaleDateString();
  }

  // Elementos do DOM para Player ID
  const playerIdDisplay = document.getElementById('playerIdDisplay');
  const playerIdInputGroup = document.getElementById('playerIdInputGroup');
  const playerIdInput = document.getElementById('playerIdInput');
  const btnSavePlayerId = document.getElementById('btnSavePlayerId');
  const btnHelpPlayerId = document.getElementById('btnHelpPlayerId');
  const modalHelpPlayerId = document.getElementById('modalHelpPlayerId');
  const btnCloseHelpModal = document.getElementById('btnCloseHelpModal');

  // Fun√ß√£o para validar Player ID (7 caracteres alfanum√©ricos)
  function validarPlayerId(id) {
    const regex = /^[A-Za-z0-9]{5,7}$/;
    return regex.test(id);
  }
  // Fun√ß√£o para carregar Player ID do Firestore
  async function carregarPlayerId(userId) {
    try {
      const userDocRef = doc(db, "usuarios", userId);
      const userDocSnap = await getDoc(userDocRef);
      
      if (userDocSnap.exists()) {
        const userData = userDocSnap.data();
        
        if (userData.playerId) {
          // J√° tem ID cadastrado - exibir
          playerIdDisplay.textContent = userData.playerId;
          playerIdDisplay.style.display = 'block';
          playerIdInputGroup.style.display = 'none';
          console.log('‚úÖ Player ID carregado:', userData.playerId);
        } else {
          // N√£o tem ID - mostrar input
          playerIdDisplay.style.display = 'none';
          playerIdInputGroup.style.display = 'flex';
          console.log('‚ÑπÔ∏è Player ID n√£o cadastrado ainda');
        }
      } else {
        // Documento n√£o existe - mostrar input
        playerIdDisplay.style.display = 'none';
        playerIdInputGroup.style.display = 'flex';
      }
    } catch (error) {
      console.error('‚ùå Erro ao carregar Player ID:', error);
      playerIdDisplay.style.display = 'none';
      playerIdInputGroup.style.display = 'flex';
    }
  }

  // Fun√ß√£o para salvar Player ID no Firestore
  async function salvarPlayerId(userId, playerId) {
    try {
      btnSavePlayerId.disabled = true;
      btnSavePlayerId.textContent = 'üíæ Saving...';
      
      const userDocRef = doc(db, "usuarios", userId);
      const userDocSnap = await getDoc(userDocRef);
      
      if (userDocSnap.exists()) {
        // Atualizar documento existente
        await updateDoc(userDocRef, {
          playerId: playerId.toUpperCase()
        });
      } else {
        // Criar novo documento
        await setDoc(userDocRef, {
          email: currentUser.email,
          role: "user",
          playerId: playerId.toUpperCase(),
          createdAt: new Date()
        });
      }
      
      console.log('‚úÖ Player ID salvo com sucesso:', playerId);
      alert('‚úÖ Player ID saved successfully!\n\nYour ID: ' + playerId.toUpperCase());
      
      // Atualizar interface
      playerIdDisplay.textContent = playerId.toUpperCase();
      playerIdDisplay.style.display = 'block';
      playerIdInputGroup.style.display = 'none';
      playerIdInput.value = '';
      
    } catch (error) {
      console.error('‚ùå Erro ao salvar Player ID:', error);
      alert('‚ùå Error saving Player ID: ' + error.message);
    } finally {
      btnSavePlayerId.disabled = false;
      btnSavePlayerId.textContent = 'üíæ Save';
    }
  }

  // Event listener para bot√£o de salvar Player ID
  btnSavePlayerId.addEventListener('click', async () => {
    const playerId = playerIdInput.value.trim().toUpperCase();
    
    if (!playerId) {
      alert('‚ö†Ô∏è Please enter your Player ID');
      return;
    }
    
    if (!validarPlayerId(playerId)) {
      alert('‚ö†Ô∏è Invalid Player ID!\n\nThe ID must be exactly 7 characters (letters and numbers only).\n\nExample: A1B2C3D');
      return;
    }
    
    const confirmacao = confirm(
      '‚ö†Ô∏è IMPORTANT: You can only set your Player ID ONCE!\n\n' +
      'Player ID: ' + playerId + '\n\n' +
      'Are you sure this is correct?\n\n' +
      'This cannot be changed later!'
    );
    
    if (!confirmacao) {
      return;
    }
    
    if (currentUser) {
      await salvarPlayerId(currentUser.uid, playerId);
    } else {
      alert('‚ùå You must be logged in to save your Player ID');
    }
  });

  // Valida√ß√£o em tempo real do input
  playerIdInput.addEventListener('input', async (e) => {
    e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
    if (e.target.value.length > 7) {
      e.target.value = e.target.value.slice(0, 7);
    }
    
    // Buscar automaticamente quando atingir 5, 6 ou 7 caracteres
    if (e.target.value.length >= 5 && e.target.value.length <= 7) {
      console.log(`üéØ ${e.target.value.length} caracteres digitados - buscando automaticamente...`);
      await buscarPerfil();
    } else {
      profileSearchResults.classList.remove('show');
    }
  });

  // Salvar ao pressionar Enter
  playerIdInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      btnSavePlayerId.click();
    }
  });

  // Event listeners para modal de ajuda
  btnHelpPlayerId.addEventListener('click', () => {
    modalHelpPlayerId.classList.add('show');
  });

  btnCloseHelpModal.addEventListener('click', () => {
    modalHelpPlayerId.classList.remove('show');
  });

  modalHelpPlayerId.addEventListener('click', (e) => {
    if (e.target === modalHelpPlayerId) {
      modalHelpPlayerId.classList.remove('show');
    }
  });

  // ========================================
// SISTEMA DE COMPARTILHAMENTO DE PERFIL
// ========================================

const btnShareProfile = document.getElementById('btnShareProfile');
const shareFeedback = document.getElementById('shareFeedback');

async function copiarLinkPerfil(userId) {
  try {
    // Construir URL do perfil no modo visualiza√ß√£o
    const baseUrl = window.location.origin;
    const profileUrl = `${baseUrl}/perfil/perfil-view.html?uid=${userId}`;
    
    console.log('üîó Link gerado:', profileUrl);
    
    // Copiar para √°rea de transfer√™ncia
    await navigator.clipboard.writeText(profileUrl);
    
    // Mostrar feedback visual
    btnShareProfile.textContent = '‚úÖ Copied!';
    btnShareProfile.style.background = 'linear-gradient(135deg, #28a745, #1e7e34)'; // Verde quando copiado
    shareFeedback.style.display = 'inline';
    
    console.log('‚úÖ Link copiado com sucesso!');
    
    // Resetar bot√£o ap√≥s 2 segundos
    setTimeout(() => {
      btnShareProfile.textContent = 'üîó Copy Link';
      btnShareProfile.style.background = 'linear-gradient(135deg, #ff7500, #ffad00)'; // ‚úÖ LARANJA DO SITE
      shareFeedback.style.display = 'none';
    }, 2000);
    
  } catch (error) {
    console.error('‚ùå Erro ao copiar link:', error);
    
    // Fallback: criar input tempor√°rio para copiar
    const tempInput = document.createElement('input');
    const baseUrl = window.location.origin;
    const profileUrl = `${baseUrl}/perfil/perfil-view.html?uid=${userId}`;
    
    tempInput.value = profileUrl;
    document.body.appendChild(tempInput);
    tempInput.select();
    
    try {
      document.execCommand('copy');
      btnShareProfile.textContent = '‚úÖ Copied!';
      btnShareProfile.style.background = 'linear-gradient(135deg, #28a745, #1e7e34)';
      shareFeedback.style.display = 'inline';
      
      setTimeout(() => {
        btnShareProfile.textContent = 'üîó Copy Link';
        btnShareProfile.style.background = 'linear-gradient(135deg, #ff7500, #ffad00)'; // ‚úÖ LARANJA DO SITE
        shareFeedback.style.display = 'none';
      }, 2000);
    } catch (err) {
      alert('‚ùå Could not copy link. Please try again.');
    }
    
    document.body.removeChild(tempInput);
  }
}

// Event listener do bot√£o
btnShareProfile.addEventListener('click', () => {
  if (!currentUser) {
    alert('‚ö†Ô∏è You need to be logged in to share your profile');
    return;
  }
  
  copiarLinkPerfil(currentUser.uid);
});
  
  // Fun√ß√£o para carregar todas as imagens da pasta sprites
  async function carregarImagensSprites() {
    const avatares = [];
    const pastaPrincial = '../estatisticas-shad/images/backgrounds/';
    
    const nomesBase = [
        'absol', 'aegislash', 'alcremie', 'armarouge', 'azumarill',
        'blastoise', 'blaziken', 'blissey', 'buzzwole', 'ceruledge',
        'chandelure', 'charizard', 'cinderace', 'clefable', 'comfey',
        'cramorant', 'crustle', 'darkrai', 'decidueye', 'delphox',
        'dhelmise', 'dodrio', 'dragapult', 'dragonite', 'duraludon',
        'eldegoss', 'empoleon', 'espeon', 'falinks', 'garchomp',
        'gardevoir', 'gengar', 'glaceon', 'goodra', 'greedent', 'greninja',
        'gyarados', 'hooh', 'hoopa', 'inteleon', 'lapras',
        'latias', 'latios', 'leafeon', 'lucario', 'machamp',
        'mamoswine', 'megacharizardx', 'megalucario', 'metagross', 'meowscara',
        'mew', 'mewtwox', 'mewtwoy', 'mimikyu', 'miraidon',
        'mrmime', 'ninetales', 'pawmot', 'pikachu', 'psyduck',
        'raichu', 'rapidash', 'sableye', 'scizor', 'scyther',
        'slowbro', 'snorlax', 'suicune', 'sylveon', 'talonflame',
        'tinkaton', 'trevenant', 'tsareena', 'tyranitar', 'umbreon',
        'urshifu', 'vaporeon','venusaur', 'wigglytuff', 'zacian', 'zeraora',
        'zoroark'
    ];
    
    for (const nome of nomesBase) {
      const img = new Image();
      img.src = `${pastaPrincial}${nome}.png`;
      
      await new Promise((resolve) => {
        img.onload = () => {
          avatares.push(nome);
          resolve();
        };
        img.onerror = () => {
          console.log(`Imagem ${nome}.png n√£o encontrada`);
          resolve();
        };
        setTimeout(resolve, 2000);
      });
    }
    
    return avatares.length > 0 ? avatares : nomesBase;
  }

  let pokemonList = [];

  // Elementos do DOM
  const userMenuToggle = document.getElementById('userMenuToggle');
  const userDropdown = document.getElementById('userDropdown');
  const userDropdownHeader = document.getElementById('userDropdownHeader');
  const authLink = document.getElementById('authLink');
  const perfilLink = document.getElementById('perfilLink');
  const perfilNomeDisplay = document.getElementById('perfilNomeDisplay');
  const perfilNomeInput = document.getElementById('perfilNomeInput');
  const btnEditNome = document.getElementById('btnEditNome');
  const perfilEmail = document.getElementById('perfilEmail');
  const avatarImg = document.getElementById('avatarImg');
  const btnChangeAvatar = document.getElementById('btnChangeAvatar');
  const modalAvatar = document.getElementById('modalAvatar');
  const btnCloseModal = document.getElementById('btnCloseModal');
  const avatarGrid = document.getElementById('avatarGrid');

  let currentUser = null;

  // Toggle do menu dropdown
  userMenuToggle.addEventListener('click', function(e) {
    e.stopPropagation();
    this.classList.toggle('active');
    userDropdown.classList.toggle('show');
  });

  // Fechar dropdown ao clicar fora
  document.addEventListener('click', function(e) {
    if (!userMenuToggle.contains(e.target) && !userDropdown.contains(e.target)) {
      userMenuToggle.classList.remove('active');
      userDropdown.classList.remove('show');
    }
  });

  // Fechar dropdown ao clicar em um link
  userDropdown.querySelectorAll('a').forEach(link => {
    link.addEventListener('click', function() {
      userMenuToggle.classList.remove('active');
      userDropdown.classList.remove('show');
    });
  });

  // Carregar avatares no modal
  async function loadAvatars() {
    avatarGrid.innerHTML = '<p style="color: #ffad00; text-align: center; grid-column: 1/-1;">Carregando avatares...</p>';
    
    if (pokemonList.length === 0) {
      pokemonList = await carregarImagensSprites();
    }
    
    avatarGrid.innerHTML = '';
    
    if (pokemonList.length === 0) {
      avatarGrid.innerHTML = '<p style="color: #ff7500; text-align: center; grid-column: 1/-1;">Nenhum avatar dispon√≠vel</p>';
      return;
    }
    
    pokemonList.forEach(pokemon => {
      const avatarOption = document.createElement('div');
      avatarOption.className = 'avatar-option';
      avatarOption.innerHTML = `<img src="../estatisticas-shad/images/backgrounds/${pokemon}-left-bg.png" alt="${pokemon}" onerror="this.parentElement.style.display='none'">`;
      avatarOption.addEventListener('click', () => selectAvatar(pokemon));
      avatarGrid.appendChild(avatarOption);
    });
  }

  // Selecionar avatar
  // Selecionar avatar
async function selectAvatar(pokemon) {
  if (!currentUser) {
    alert('‚ùå Voc√™ precisa estar logado para alterar o avatar');
    return;
  }
  
  try {
    const avatarPath = `../estatisticas-shad/images/backgrounds/${pokemon}-left-bg.png`;
    
    // Salvar no Firestore
    const userDocRef = doc(db, "usuarios", currentUser.uid);
    const userDocSnap = await getDoc(userDocRef);
    
    if (userDocSnap.exists()) {
      await updateDoc(userDocRef, {
        avatar: avatarPath,
        updatedAt: new Date()
      });
    } else {
      await setDoc(userDocRef, {
        email: currentUser.email,
        role: "user",
        avatar: avatarPath,
        createdAt: new Date()
      });
    }
    
    // Atualizar interface
    avatarImg.src = avatarPath;
    modalAvatar.classList.remove('show');
    
    console.log('‚úÖ Avatar atualizado:', pokemon);
    
  } catch (error) {
    console.error('‚ùå Erro ao salvar avatar:', error);
    alert('‚ùå Erro ao salvar avatar: ' + error.message);
  }
}

  // Abrir modal ao clicar no avatar
  const perfilAvatar = document.getElementById('perfilAvatar');
  perfilAvatar.addEventListener('click', () => {
    loadAvatars();
    modalAvatar.classList.add('show');
  });

  // Fechar modal
  btnCloseModal.addEventListener('click', () => {
    modalAvatar.classList.remove('show');
  });

  // Fechar modal ao clicar fora
  modalAvatar.addEventListener('click', (e) => {
    if (e.target === modalAvatar) {
      modalAvatar.classList.remove('show');
    }
  });

  // Editar nome
  btnEditNome.addEventListener('click', () => {
    perfilNomeInput.value = perfilNomeDisplay.textContent;
    perfilNomeDisplay.style.display = 'none';
    btnEditNome.style.display = 'none';
    perfilNomeInput.style.display = 'block';
    perfilNomeInput.focus();
  });

// Salvar nome ao pressionar Enter ou perder foco
async function salvarNome() {
  const novoNome = perfilNomeInput.value.trim();
  
  if (!novoNome || novoNome === perfilNomeDisplay.textContent) {
    perfilNomeInput.style.display = 'none';
    perfilNomeDisplay.style.display = 'block';
    btnEditNome.style.display = 'inline-block';
    return;
  }
  
  if (!currentUser) {
    alert('‚ùå Voc√™ precisa estar logado para alterar o nome');
    return;
  }
  
  try {
    btnEditNome.disabled = true;
    perfilNomeInput.disabled = true;
    
    // ‚úÖ BUSCAR AVATAR ATUAL DO FIRESTORE
    const userDocRef = doc(db, "usuarios", currentUser.uid);
    const userDocSnap = await getDoc(userDocRef);
    
    let avatarPath = '../estatisticas-shad/images/backgrounds/pikachu-left-bg.png'; // Default
    
    if (userDocSnap.exists()) {
      const userData = userDocSnap.data();
      if (userData.avatar) {
        avatarPath = userData.avatar;
      }
      
      // Atualizar no Firestore
      await updateDoc(userDocRef, {
        displayName: novoNome,
        updatedAt: new Date()
      });
    } else {
      // Criar novo documento se n√£o existir
      await setDoc(userDocRef, {
        email: currentUser.email,
        role: "user",
        displayName: novoNome,
        avatar: avatarPath,
        createdAt: new Date()
      });
    }
    
    // Atualizar no Firebase Auth
    await updateProfile(currentUser, {
      displayName: novoNome
    });
    
    perfilNomeDisplay.textContent = novoNome;
    
    // ‚úÖ ATUALIZAR INTERFACE COM AVATAR CORRETO
    userDropdownHeader.innerHTML = `
      <img src="${avatarPath}" alt="Avatar" class="dropdown-avatar">
      <span>Ol√°, ${novoNome}!</span>
    `;
    
    console.log('‚úÖ Nome atualizado com sucesso:', novoNome);
    alert('‚úÖ Nome atualizado com sucesso!');
    
  } catch (error) {
    console.error('‚ùå Erro ao atualizar nome:', error);
    alert('‚ùå Erro ao atualizar nome: ' + error.message);
  } finally {
    btnEditNome.disabled = false;
    perfilNomeInput.disabled = false;
    perfilNomeInput.style.display = 'none';
    perfilNomeDisplay.style.display = 'block';
    btnEditNome.style.display = 'inline-block';
  }
}

  perfilNomeInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      salvarNome();
    }
  });

  perfilNomeInput.addEventListener('blur', salvarNome);

// Fun√ß√£o para atualizar a interface
async function updateUI(user) {
  currentUser = user;
  
  if (user) {
    try {
      // üî• BUSCAR DADOS DO FIRESTORE
      const userDocRef = doc(db, "usuarios", user.uid);
      const userDocSnap = await getDoc(userDocRef);
      
      let displayName = user.displayName || user.email.split('@')[0];
      let avatarPath = '../estatisticas-shad/images/sprites/pikachu.png';
      
      // Se existe documento no Firestore, usar os dados de l√°
      if (userDocSnap.exists()) {
        const userData = userDocSnap.data();
        if (userData.displayName) {
          displayName = userData.displayName;
        }
        if (userData.avatar) {
          avatarPath = userData.avatar;
        }
      }
      
      // Atualizar interface
      perfilNomeDisplay.textContent = displayName;
      perfilEmail.textContent = user.email;
      avatarImg.src = avatarPath;
      
      // Atualizar interface
          userDropdownHeader.innerHTML = `
            <img src="${avatarPath}" alt="Avatar" class="dropdown-avatar">
            <span>Ol√°, ${displayName}!</span>
          `;
      authLink.textContent = 'Logout';
      authLink.onclick = function(e) {
        e.preventDefault();
        handleLogout();
      };
      perfilLink.style.display = 'block';
      
      if (btnChangeAvatar) btnChangeAvatar.disabled = false;
      btnEditNome.disabled = false;
      btnShareProfile.disabled = false;
      
      console.log('‚úÖ Usu√°rio logado:', user.email);
      
      // Carregar dados do usu√°rio
      await carregarBuildsUsuario(user.uid);
      await carregarPlayerId(user.uid);
      await carregarUltimasVisualizacoes(user.uid);
      
    } catch (error) {
      console.error('‚ùå Erro ao carregar dados do usu√°rio:', error);
      // Fallback para dados b√°sicos
      perfilNomeDisplay.textContent = user.displayName || user.email.split('@')[0];
      perfilEmail.textContent = user.email;
    }
    
  } else {
    window.location.href = '../login/login.html';
  }
}

  // Fun√ß√£o para fazer logout
  async function handleLogout() {
  const confirmar = confirm('Deseja realmente fazer logout?');
  if (confirmar) {
    try {
      // üî• LIMPAR DADOS DO LOCALSTORAGE
      localStorage.removeItem('userDisplayName');
      localStorage.removeItem('userAvatar');
      
      await signOut(auth);
      alert('Logout realizado com sucesso!');
      window.location.href = '../index.html';
    } catch (error) {
      console.error('Erro no logout:', error);
      alert('Erro ao fazer logout. Tente novamente.');
    }
  }
}

  onAuthStateChanged(auth, (user) => {
    updateUI(user);
    
    carregarImagensSprites().then(lista => {
      pokemonList = lista;
      console.log(`${pokemonList.length} avatares carregados`);
      
      // Inicializar sistema de ribbons ap√≥s carregar pok√©mons
      if (user && pokemonList.length > 0) {
        initRibbons(user.uid, pokemonList, db);
      }
    });
  });
</script>

  <!-- Scripts principais -->
  <script>
    // Funcionalidade do menu mobile
    const menuToggle = document.querySelector('.menu-toggle');
    const mobileMenu = document.querySelector('.mobile-menu');

    menuToggle.addEventListener('click', function() {
      this.classList.toggle('ativo');
      mobileMenu.classList.toggle('ativo');
    });

    // Fechar menu ao clicar em um link
    const mobileLinks = document.querySelectorAll('.mobile-menu a');
    mobileLinks.forEach(link => {
      link.addEventListener('click', function() {
        menuToggle.classList.remove('ativo');
        mobileMenu.classList.remove('ativo');
      });
    });

    // Fechar menu ao redimensionar para desktop
    window.addEventListener('resize', function() {
      if (window.innerWidth > 900) {
        menuToggle.classList.remove('ativo');
        mobileMenu.classList.remove('ativo');
      }
    });
  </script>

</body>
</html>