<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Visualizar perfil - Guarini e-sport">
  <title>Player Profile - Guarini e-sport</title>
  <link rel="icon" href="favicon.png" type="image/png">
  <link rel="stylesheet" href="../style.css">
  <link rel="stylesheet" href="perfil.css">
  <meta name="theme-color" content="#ffad00">
</head>

<body>
  <a id="topo"></a>

  <header>
    <div class="header-wrapper">
      <nav class="nav-group left-nav">
        <ul>
          <li><a href="../loja/loja.html">Shop</a></li>
          <li><a href="../sobre/sobre.html">About</a></li>
        </ul>
      </nav>
      
      <div class="logo-center">
        <a href="../index.html" aria-label="In√≠cio">
          <img src="../img-site/grn-logo.png" alt="Guarini e-sport" class="header-logo">
        </a>
      </div>

      <nav class="nav-group right-nav">
        <ul>
          <li><a href="../groups/groups.html">Games</a></li>
          <li><a href="../contato/contato.html">Contact</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <!-- Menu dropdown do usu√°rio -->
  <div class="user-menu-container">
    <button class="user-menu-toggle" id="userMenuToggle" aria-label="Menu do usu√°rio">
      <span></span>
      <span></span>
      <span></span>
    </button>
    
    <div class="user-dropdown" id="userDropdown">
      <div class="user-dropdown-header" id="userDropdownHeader">
        <span>Hello, visitor!</span>
      </div>
      <ul class="user-dropdown-list">
        <li><a href="./perfil.html" id="perfilLink">Profile</a></li>
        <li><a href="../loja/loja.html">Shop</a></li>
        <li><a href="../sobre/sobre.html">About</a></li>
        <li><a href="../groups/groups.html">Games</a></li>
        <li><a href="../contato/contato.html">Contact</a></li>
        <li><a href="#" id="authLink">Login</a></li>
      </ul>
    </div>
  </div>

  <div class="profile-search-container">
    <div class="profile-search-wrapper">
      <input 
        type="text" 
        id="profileSearchInput" 
        class="profile-search-input" 
        placeholder="Search Player ID..."
        maxlength="7"
      >
      <button class="profile-search-btn" id="profileSearchBtn" title="Search Profile">
        üîç
      </button>
    </div>
    <div class="profile-search-results" id="profileSearchResults"></div>
  </div>

  <main>
    <section class="perfil-section">
      <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
        <button onclick="history.back()" style="background: #ffad00; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">
          ‚Üê Back
        </button>
        <h2 style="margin: 0;">Player Profile</h2>
      </div>
      
      <!-- Card de Perfil (Modo Visualiza√ß√£o - SEM EMAIL) -->
      <div class="perfil-card">
        <div class="perfil-avatar-container">
          <div class="perfil-avatar" id="perfilAvatar">
            <img src="../estatisticas-shad/images/backgrounds/pikachu-left-bg.png" alt="Avatar do usu√°rio" id="avatarImg">
          </div>
        </div>

        <div class="perfil-info">
          <div class="perfil-nome-container">
            <h3 id="perfilNomeDisplay">Loading...</h3>
          </div>
          <!-- EMAIL REMOVIDO - n√£o ser√° exibido -->
          
          <div class="perfil-player-id-container">
            <p class="perfil-player-id-label">Unite ID:</p>
            <p class="perfil-player-id-display" id="playerIdDisplay">-</p>
          </div>
        </div>
      </div>  

      <!-- √Årea de builds (somente visualiza√ß√£o) -->
      <section class="perfil-section">
        <h2>Saved Builds</h2>
        
        <div class="perfil-content">
          <div id="builds-container-perfil" class="builds-container">
            <div class="builds-loading">Loading builds...</div>
          </div>
        </div>
      </section>

      <!-- √Årea para Battle Ribbons List (Visualiza√ß√£o) -->
      <section class="perfil-section">
        <h2>Battle Ribbons List</h2>
        
        <div class="perfil-content">
          <div id="ribbons-loading" class="builds-loading" style="display: none;">
            Loading ribbons...
          </div>
          
          <div id="ribbons-empty" class="no-builds-message" style="display: none;">
            This player hasn't created a ribbons list yet.
          </div>
          
          <div id="ribbons-container" style="display: none;">
            <!-- Gold Ribbon -->
            <div class="ribbon-tier">
              <div class="ribbon-icon-container">
                <img src="../estatisticas-shad/images/icons/dourado.png" alt="Gold Ribbon" class="ribbon-icon">
              </div>
              <div class="ribbon-pokemon-list ribbon-pokemon-list-view" id="goldRibbonListView">
                <!-- Pok√©mons ser√£o carregados aqui -->
              </div>
            </div>

            <!-- Blue Ribbon -->
            <div class="ribbon-tier">
              <div class="ribbon-icon-container">
                <img src="../estatisticas-shad/images/icons/azul.png" alt="Blue Ribbon" class="ribbon-icon">
              </div>
              <div class="ribbon-pokemon-list ribbon-pokemon-list-view" id="blueRibbonListView">
                <!-- Pok√©mons ser√£o carregados aqui -->
              </div>
            </div>

            <!-- Green Ribbon -->
            <div class="ribbon-tier">
              <div class="ribbon-icon-container">
                <img src="../estatisticas-shad/images/icons/verde.png" alt="Green Ribbon" class="ribbon-icon">
              </div>
              <div class="ribbon-pokemon-list ribbon-pokemon-list-view" id="greenRibbonListView">
                <!-- Pok√©mons ser√£o carregados aqui -->
              </div>
            </div>
          </div>
        </div>
      </section>
    </section>
  </main>

  <footer>
    <div class="footer-info">
        <p>&copy; ¬© 2019 Guarin√≠ E-sport. All rights reserved.</p>
        <p><a href="https://linktr.ee/guariniesports" target="_blank">Follow us on social media!</a></p>
        <p>Created by: Lobo & Shad</p>
      </div>
    </div>
  </footer>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { 
    getAuth, 
    onAuthStateChanged, 
    signOut 
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import { 
    getFirestore, 
    doc, 
    getDoc,
    updateDoc,
    collection, 
    query,
    where,
    getDocs 
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

  // Importar sistema de avalia√ß√£o
  import { createRatingHTML, initRatingEvents } from './build-rating.js';

  // Expor para uso global
  window.createRatingHTML = createRatingHTML;
  window.initRatingEvents = initRatingEvents;

  const firebaseConfig = {
    apiKey: "AIzaSyC9LLCXrQTHBagQxaChBazSfS5E4gUPIoI",
    authDomain: "site-grn.firebaseapp.com",
    projectId: "site-grn",
    storageBucket: "site-grn.firebasestorage.app",
    messagingSenderId: "27613322806",
    appId: "1:27613322806:web:ad4dc08ce043f19d530297",
    measurementId: "G-84NHN394WF"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore();
  const auth = getAuth(app);
  let currentUser = null;

  // ========================================
  // ELEMENTOS DO DOM - BUSCA DE PERFIL
  // ========================================
  const profileSearchBtn = document.getElementById('profileSearchBtn');
  const profileSearchInput = document.getElementById('profileSearchInput');
  const profileSearchResults = document.getElementById('profileSearchResults');

  // ========================================
  // BUSCA DE PERFIL - COM BUSCA AUTOM√ÅTICA
  // ========================================

  // Fun√ß√£o para buscar perfil
  async function buscarPerfil() {
    const playerId = profileSearchInput.value.trim().toUpperCase();
    
    if (!playerId) {
      profileSearchResults.classList.remove('show');
      return;
    }
    
    if (playerId.length < 5 || playerId.length > 7) {
      profileSearchResults.classList.remove('show');
      return;
    }
    
    try {
      profileSearchResults.innerHTML = '<div class="profile-search-no-results">üîç Searching...</div>';
      profileSearchResults.classList.add('show');
      
      console.log('üîç Buscando Player ID:', playerId);
      
      const usuariosRef = collection(db, "usuarios");
      const q = query(usuariosRef, where("playerId", "==", playerId));
      
      console.log('üì° Query criada, executando busca...');
      
      const querySnapshot = await getDocs(q);
      
      console.log('üì¶ Resultado da busca:', {
        empty: querySnapshot.empty,
        size: querySnapshot.size
      });
      
      if (querySnapshot.empty) {
        console.log('‚ùå Nenhum usu√°rio encontrado com Player ID:', playerId);
        profileSearchResults.innerHTML = '<div class="profile-search-no-results">‚ùå Player not found</div>';
        return;
      }
      
      const userDoc = querySnapshot.docs[0];
      const userData = userDoc.data();
      const foundUserId = userDoc.id;
      
      console.log('‚úÖ Usu√°rio encontrado:', {
        userId: foundUserId,
        playerId: userData.playerId,
        displayName: userData.displayName,
        email: userData.email
      });
      
      profileSearchResults.innerHTML = `
        <div class="profile-search-result-item" style="background: rgba(255, 173, 0, 0.1); cursor: default;">
          <div style="flex: 1;">
            <div style="color: #ffad00; font-weight: bold; margin-bottom: 5px;">
              ‚úÖ Player found!
            </div>
            <div style="color: #fff; font-size: 13px;">
              ${userData.displayName || 'Anonymous'}
            </div>
            <div style="color: #aaa; font-size: 11px; margin-top: 3px;">
              ID: ${userData.playerId}
            </div>
          </div>
        </div>
        <div style="margin-top: 10px; text-align: center;">
          <button 
            onclick="window.location.href='perfil-view.html?uid=${foundUserId}'" 
            style="background: linear-gradient(45deg, #ff7500, #ffad00); border: none; padding: 10px 20px; border-radius: 8px; color: #000; font-weight: bold; cursor: pointer; transition: all 0.3s ease;"
            onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 5px 15px rgba(255, 173, 0, 0.5)'"
            onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'"
          >
            üë§ View Profile
          </button>
        </div>
      `;
      
    } catch (error) {
      console.error('‚ùå Erro ao buscar perfil:', error);
      console.error('Detalhes do erro:', {
        message: error.message,
        code: error.code,
        stack: error.stack
      });
      
      profileSearchResults.innerHTML = `
        <div class="profile-search-no-results" style="color: #ff6b6b;">
          ‚ùå Search error<br>
          <small style="font-size: 11px; color: #aaa; margin-top: 5px; display: block;">
            ${error.message}
          </small>
        </div>
      `;
    }
  }

  // Toggle da barra de busca
  profileSearchBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    console.log('üñ±Ô∏è Bot√£o de busca clicado');
    profileSearchInput.classList.toggle('active');
    
    if (profileSearchInput.classList.contains('active')) {
      console.log('‚úÖ Input ativado');
      profileSearchInput.focus();
    } else {
      console.log('‚ùå Input desativado');
      profileSearchInput.value = '';
      profileSearchResults.classList.remove('show');
    }
  });

  // Buscar ao pressionar Enter
  profileSearchInput.addEventListener('keypress', async (e) => {
    if (e.key === 'Enter') {
      console.log('‚å®Ô∏è Enter pressionado');
      await buscarPerfil();
    }
  });

  // Valida√ß√£o e busca autom√°tica ao digitar 7 caracteres
  profileSearchInput.addEventListener('input', async (e) => {
    e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
    if (e.target.value.length > 7) {
      e.target.value = e.target.value.slice(0, 7);
    }
    
    if (e.target.value.length >= 5 && e.target.value.length <= 7) {
      console.log('üéØ 7 caracteres digitados - buscando automaticamente...');
      await buscarPerfil();
    } else {
      profileSearchResults.classList.remove('show');
    }
  });

  // Fechar ao clicar fora
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.profile-search-container')) {
      profileSearchInput.classList.remove('active');
      profileSearchResults.classList.remove('show');
    }
  });

  // ========================================
  // MENU DROPDOWN DO USU√ÅRIO
  // ========================================
  const userMenuToggle = document.getElementById('userMenuToggle');
  const userDropdown = document.getElementById('userDropdown');
  const userDropdownHeader = document.getElementById('userDropdownHeader');
  const authLink = document.getElementById('authLink');
  const perfilLink = document.getElementById('perfilLink');

  // Toggle do menu dropdown
  userMenuToggle.addEventListener('click', function(e) {
    e.stopPropagation();
    this.classList.toggle('active');
    userDropdown.classList.toggle('show');
  });

  // Fechar dropdown ao clicar fora
  document.addEventListener('click', function(e) {
    if (!userMenuToggle.contains(e.target) && !userDropdown.contains(e.target)) {
      userMenuToggle.classList.remove('active');
      userDropdown.classList.remove('show');
    }
  });

  // Fechar dropdown ao clicar em um link
  userDropdown.querySelectorAll('a').forEach(link => {
    link.addEventListener('click', function() {
      userMenuToggle.classList.remove('active');
      userDropdown.classList.remove('show');
    });
  });

  // Fun√ß√£o para fazer logout
  async function handleLogout() {
    const confirmar = confirm('Deseja realmente fazer logout?');
    if (confirmar) {
      try {
        localStorage.removeItem('userDisplayName');
        localStorage.removeItem('userAvatar');
        
        await signOut(auth);
        alert('Logout realizado com sucesso!');
        window.location.href = '../index.html';
      } catch (error) {
        console.error('Erro no logout:', error);
        alert('Erro ao fazer logout. Tente novamente.');
      }
    }
  }

// Fun√ß√£o para atualizar UI do menu dropdown
async function atualizarMenuUsuario(user) {
  if (user) {
    try {
      // Buscar dados do Firestore
      const userDocRef = doc(db, "usuarios", user.uid);
      const userDocSnap = await getDoc(userDocRef);
      
      let displayName = user.displayName || user.email.split('@')[0];
      let avatarPath = '../estatisticas-shad/images/backgrounds/pikachu-left-bg.png';
      
      // Se existe documento no Firestore, usar os dados de l√°
      if (userDocSnap.exists()) {
        const userData = userDocSnap.data();
        if (userData.displayName) {
          displayName = userData.displayName;
        }
        if (userData.avatar) {
          avatarPath = userData.avatar;
        }
      }
      
      // ‚úÖ ATUALIZAR MENU DROPDOWN COM AVATAR
      userDropdownHeader.innerHTML = `
        <img src="${avatarPath}" alt="Avatar" class="dropdown-avatar">
        <span>Ol√°, ${displayName}!</span>
      `;
      
    } catch (error) {
      console.error('Erro ao carregar dados:', error);
      // Fallback
      const displayName = user.displayName || user.email.split('@')[0];
      userDropdownHeader.innerHTML = `
        <img src="../estatisticas-shad/images/backgrounds/pikachu-left-bg.png" alt="Avatar" class="dropdown-avatar">
        <span>Ol√°, ${displayName}!</span>
      `;
    }
      authLink.textContent = 'Logout';
      authLink.onclick = function(e) {
        e.preventDefault();
        handleLogout();
      };
      perfilLink.style.display = 'block';
      console.log('‚úÖ Menu dropdown atualizado para:', displayName);
    } else {
      userDropdownHeader.innerHTML = '<span>Ol√°, visitante!</span>';
      authLink.textContent = 'Login';
      authLink.onclick = function(e) {
        e.preventDefault();
        window.location.href = '../login/login.html';
      };
      perfilLink.style.display = 'none';
    }
  }

  // Monitorar estado de autentica√ß√£o
  onAuthStateChanged(auth, (user) => {
    currentUser = user;
    atualizarMenuUsuario(user);
  });

  // Pegar UID da URL
  const urlParams = new URLSearchParams(window.location.search);
  const userId = urlParams.get('uid');

  if (!userId) {
    alert('‚ùå User not found');
    window.location.href = '../index.html';
  }

  // Elementos do DOM
  const perfilNomeDisplay = document.getElementById('perfilNomeDisplay');
  const avatarImg = document.getElementById('avatarImg');
  const playerIdDisplay = document.getElementById('playerIdDisplay');
  const buildsContainer = document.getElementById('builds-container-perfil');

  // Fun√ß√£o para capitalizar primeira letra
  function capitalizeFirst(str) {
    if (!str) return '';
    return str.charAt(0).toUpperCase() + str.slice(1);
  }
 // ===== ADICIONE ESTAS FUN√á√ïES AUXILIARES ANTES DA FUN√á√ÉO createBuildCard =====

/**
 * Converte selectedSkills do Firebase para formato do card
 * @param {Object} selectedSkills - { s1: "s11", s2: "s12" }
 * @returns {Object} - { skill1: { name, key }, skill2: { name, key } }
 */
function processSkillsFromFirebase(selectedSkills) {
  if (!selectedSkills) return { skill1: null, skill2: null };
  
  const result = {};
  
  // Processar skill 1
  if (selectedSkills.s1 && selectedSkills.s1 !== 'none') {
    const skillKey = selectedSkills.s1; // ex: "s11"
    result.skill1 = {
      key: skillKey,
      name: formatSkillName(skillKey)
    };
  } else {
    result.skill1 = null;
  }
  
  // Processar skill 2
  if (selectedSkills.s2 && selectedSkills.s2 !== 'none') {
    const skillKey = selectedSkills.s2; // ex: "s12"
    result.skill2 = {
      key: skillKey,
      name: formatSkillName(skillKey)
    };
  } else {
    result.skill2 = null;
  }
  
  return result;
}

/**
 * Formata nome da skill baseado na key
 */
function formatSkillName(skillKey) {
  if (!skillKey) return 'Unknown';
  const num = skillKey.replace('s', '');
  return `Skill ${num}`;
}

/**
 * Converte selectedEmblems do Firebase para formato do card
 * @param {Object} selectedEmblems - { brown: "6", red: "7", white: "6" }
 * @returns {Object} - { emblem1: { color, level }, emblem2: {...}, emblem3: {...}, emblem4: {...} }
 */
function processEmblemsFromFirebase(selectedEmblems) {
  if (!selectedEmblems) return { emblem1: null, emblem2: null, emblem3: null, emblem4: null };
  
  const result = {};
  const colors = ['brown', 'red', 'white', 'black', 'blue', 'yellow', 'green', 'purple', 'pink', 'gray', 'navy'];
  
  // Converter objeto em array de emblems v√°lidos
  const emblems = [];
  colors.forEach(color => {
    if (selectedEmblems[color] && selectedEmblems[color] !== 'none' && selectedEmblems[color] !== '0') {
      emblems.push({
        color: color,
        level: parseInt(selectedEmblems[color]) || 0
      });
    }
  });
  
  // Atribuir aos slots (m√°ximo 4)
  result.emblem1 = emblems[0] || null;
  result.emblem2 = emblems[1] || null;
  result.emblem3 = emblems[2] || null;
  result.emblem4 = emblems[3] || null;
  
  return result;
}

// ===== SUBSTITUA A FUN√á√ÉO createBuildCard COMPLETA POR ESTA =====

function createBuildCard(build, isOwnProfile = false) {
  console.log('üé® Criando card para build:', build);
  
  const pokemonImage = build.pokemon ? 
    `../estatisticas-shad/images/backgrounds/${build.pokemon}-left-bg.png` : 
    '../estatisticas-shad/images/backgrounds/placeholder.png';
  
  const pokemonName = capitalizeFirst(build.pokemon);
  const roleInfo = getPokemonRole(build.pokemon);
  
  // Battle Item
  const battleItemHTML = build.battleItem ? `
    <div class="build-item-circle">
      <img src="../estatisticas-shad/images/battle-items/${build.battleItem}.png" 
           alt="Battle Item"
           onerror="this.style.display='none'">
    </div>
  ` : '';
  
  // Held Items (m√°ximo 3)
  const heldItemsHTML = build.heldItems && build.heldItems.length > 0 ? 
    build.heldItems.slice(0, 3).map(item => `
      <div class="build-item-circle">
        <img src="../estatisticas-shad/images/held-itens/${item.key}.png" 
             alt="${item.name}"
             title="${item.name}${item.stacks > 0 ? ` (${item.stacks} stacks)` : ''}"
             onerror="this.style.display='none'">
      </div>
    `).join('') : 
    '<span style="color: #888; font-size: 10px;">No items</span>';
  
  // Processar skills
  const processedSkills = processSkillsFromFirebase(build.selectedSkills);
  
  const skillsHTML = [];
  for (let i = 1; i <= 2; i++) {
    const skill = processedSkills[`skill${i}`];
    
    if (skill && skill.key) {
      const skillImagePath = `../estatisticas-shad/images/skills/${build.pokemon}_${skill.key}.png`;
      
      skillsHTML.push(`
        <div class="build-skill-circle" title="${skill.name}">
          <img src="${skillImagePath}" 
               alt="${skill.name}"
               onerror="this.parentElement.classList.add('empty'); this.style.display='none'">
        </div>
      `);
    } else {
      skillsHTML.push(`
        <div class="build-skill-circle empty" title="No skill selected"></div>
      `);
    }
  }
  
  // Processar emblems
  const processedEmblems = processEmblemsFromFirebase(build.selectedEmblems);

  const emblemsHTML = [];
  for (let i = 1; i <= 4; i++) {
    const emblem = processedEmblems[`emblem${i}`];
    
    if (emblem && emblem.color) {
      const level = emblem.level || 0;
      const colorName = capitalizeFirst(emblem.color);
      
      emblemsHTML.push(`
        <div class="build-emblem-item">
          <div class="build-emblem-color" 
               title="${colorName} Emblem - Level ${level}">
            <img src="../estatisticas-shad/images/icons/${emblem.color}.png" 
                 alt="${colorName}"
                 style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;"
                 onerror="this.style.display='none'; this.parentElement.classList.add('emblem-${emblem.color}')">
          </div>
          <div class="build-emblem-level">Lv.${level}</div>
        </div>
      `);
    } else {
      emblemsHTML.push(`
        <div class="build-emblem-item">
          <div class="build-emblem-color empty" title="No emblem"></div>
          <div class="build-emblem-level empty">-</div>
        </div>
      `);
    }
  }

  // ‚≠ê CRIAR HTML DE AVALIA√á√ÉO (importar de build-rating.js)
  const ratingHTML = window.createRatingHTML ? 
    window.createRatingHTML(build.id, build.ratings, isOwnProfile, currentUser?.uid) : 
    '';

  return `
    <div class="build-with-rating">
      ${ratingHTML}
      
      <div class="build-card-perfil" data-build-id="${build.id}">
        <div class="build-pokemon-image">
          <img src="${pokemonImage}" 
               alt="${pokemonName}"
               onerror="this.src='../estatisticas-shad/images/backgrounds/placeholder.png'">
        </div>
        
        <h3 class="build-pokemon-name">${pokemonName}</h3>
        
        ${roleInfo ? `
          <div class="build-pokemon-role">
            <img src="../estatisticas-shad/images/roles/${roleInfo.icon}.png" 
                 alt="${roleInfo.name}"
                 onerror="this.style.display='none'">
            <span>${roleInfo.name}</span>
          </div>
        ` : ''}
        
        <div class="build-details">
          <p class="build-name-header">${build.buildName}</p>
          
          <div class="build-items-section">
          ${battleItemHTML ? `
            <div class="build-battle-item">
              ${battleItemHTML}
            </div>
          ` : ''}
          
          <div class="build-held-items">
            ${heldItemsHTML}
          </div>
        </div>
        
        <div class="build-skills-section">
          ${skillsHTML.join('')}
        </div>
        
        <div class="build-emblems-section">
          ${emblemsHTML.join('')}
        </div>
      </div>
    </div>
    </div>
  `;
}

  // Fun√ß√£o auxiliar para obter role do Pok√©mon
  function getPokemonRole(pokemonKey) {
    // Voc√™ precisar√° importar ou replicar a l√≥gica do pokemonRoles aqui
    // Por enquanto, retorna null - voc√™ pode adicionar a l√≥gica depois
    return null;
  }

  // ========================================
  // CARREGAR RIBBONS DO USU√ÅRIO (VISUALIZA√á√ÉO)
  // ========================================
  async function carregarRibbonsUsuario(uid) {
    try {
      const ribbonsLoading = document.getElementById('ribbons-loading');
      const ribbonsEmpty = document.getElementById('ribbons-empty');
      const ribbonsContainer = document.getElementById('ribbons-container');
      
      // Mostrar loading
      ribbonsLoading.style.display = 'block';
      ribbonsEmpty.style.display = 'none';
      ribbonsContainer.style.display = 'none';
      
      console.log('üéÄ Carregando ribbons do usu√°rio:', uid);
      
      const userDocRef = doc(db, "usuarios", uid);
      const userDocSnap = await getDoc(userDocRef);
      
      if (!userDocSnap.exists() || !userDocSnap.data().battleRibbons) {
        console.log('‚ÑπÔ∏è Usu√°rio n√£o possui ribbons cadastradas');
        ribbonsLoading.style.display = 'none';
        ribbonsEmpty.style.display = 'block';
        return;
      }
      
      const ribbonState = userDocSnap.data().battleRibbons;
      console.log('‚úÖ Ribbons carregadas:', ribbonState);
      
      // Verificar se h√° algum pok√©mon em qualquer tier
      const totalPokemons = (ribbonState.gold?.length || 0) + 
                           (ribbonState.blue?.length || 0) + 
                           (ribbonState.green?.length || 0);
      
      if (totalPokemons === 0) {
        console.log('‚ÑπÔ∏è Lista de ribbons est√° vazia');
        ribbonsLoading.style.display = 'none';
        ribbonsEmpty.style.display = 'block';
        return;
      }
      
      // Renderizar ribbons
      renderizarTierView('gold', ribbonState.gold || []);
      renderizarTierView('blue', ribbonState.blue || []);
      renderizarTierView('green', ribbonState.green || []);
      
      // Mostrar container
      ribbonsLoading.style.display = 'none';
      ribbonsContainer.style.display = 'block';
      
      console.log('‚úÖ Ribbons renderizadas com sucesso');
      
    } catch (error) {
      console.error('‚ùå Erro ao carregar ribbons:', error);
      const ribbonsLoading = document.getElementById('ribbons-loading');
      const ribbonsEmpty = document.getElementById('ribbons-empty');
      
      ribbonsLoading.style.display = 'none';
      ribbonsEmpty.style.display = 'block';
      ribbonsEmpty.innerHTML = `
        <div style="color: #ff6b6b;">
          ‚ùå Error loading ribbons
        </div>
      `;
    }
  }

  // Fun√ß√£o para renderizar tier no modo visualiza√ß√£o
  function renderizarTierView(tier, pokemons) {
    const listElement = document.getElementById(`${tier}RibbonListView`);
    
    if (!listElement) {
      console.error(`‚ùå Elemento da tier ${tier} n√£o encontrado`);
      return;
    }
    
    // Limpar conte√∫do
    listElement.innerHTML = '';
    
    if (pokemons.length === 0) {
      listElement.innerHTML = '<div class="ribbon-tier-empty">No Pok√©mon selected</div>';
      return;
    }
    
    // Adicionar pok√©mons (sem interatividade)
    pokemons.forEach(pokemon => {
      const pokemonItem = document.createElement('div');
      pokemonItem.className = 'ribbon-pokemon-item';
      pokemonItem.setAttribute('data-pokemon', pokemon);
      pokemonItem.innerHTML = `
        <img src="../estatisticas-shad/images/backgrounds/${pokemon}-left-bg.png" 
             alt="${pokemon}"
             onerror="this.src='../estatisticas-shad/images/backgrounds/placeholder.png'">
      `;
      
      listElement.appendChild(pokemonItem);
    });
    
    console.log(`‚úÖ Tier ${tier} renderizada com ${pokemons.length} pok√©mons (modo visualiza√ß√£o)`);
  }

  // ========================================
  // REGISTRAR VISUALIZA√á√ÉO DO PERFIL
  // ========================================
  async function registrarVisualizacao(profileUserId, viewerUserId) {
    try {
      console.log('üëÅÔ∏è Iniciando registro de visualiza√ß√£o...');
      console.log('   - Perfil visitado:', profileUserId);
      console.log('   - Visitante:', viewerUserId);
      
      const profileDocRef = doc(db, "usuarios", profileUserId);
      const profileDocSnap = await getDoc(profileDocRef);
      
      if (!profileDocSnap.exists()) {
        console.log('‚ùå Perfil n√£o encontrado');
        return;
      }
      
      console.log('‚úÖ Perfil encontrado, preparando para registrar...');
      
      const profileData = profileDocSnap.data();
      let existingViews = profileData.profileViews || [];
      
      console.log('üìã Visualiza√ß√µes existentes:', existingViews.length);
      
      // Remover visualiza√ß√£o anterior deste usu√°rio (se existir)
      existingViews = existingViews.filter(v => v.viewerId !== viewerUserId);
      
      // Adicionar nova visualiza√ß√£o no in√≠cio
      const newView = {
        viewerId: viewerUserId,
        timestamp: new Date()
      };
      
      existingViews.unshift(newView); // Adiciona no in√≠cio
      
      // Limitar a 20 visualiza√ß√µes mais recentes
      if (existingViews.length > 20) {
        existingViews = existingViews.slice(0, 20);
      }
      
      console.log('üíæ Salvando visualiza√ß√£o...');
      
      // Atualizar documento
      await updateDoc(profileDocRef, {
        profileViews: existingViews
      });
      
      console.log('‚úÖ Visualiza√ß√£o registrada com sucesso!');
      console.log('üìä Total de visualiza√ß√µes agora:', existingViews.length);
      
    } catch (error) {
      console.error('‚ùå Erro ao registrar visualiza√ß√£o:', error);
      console.error('   Detalhes:', {
        code: error.code,
        message: error.message
      });
    }
  }

  // Carregar dados do usu√°rio (SEM EXIBIR EMAIL)
  async function carregarDadosUsuario() {
    try {
      const userDocRef = doc(db, "usuarios", userId);
      const userDocSnap = await getDoc(userDocRef);
      
      if (!userDocSnap.exists()) {
        alert('‚ùå User not found');
        window.location.href = '../index.html';
        return;
      }
      
      const userData = userDocSnap.data();
      
      // Atualizar interface - SEM EMAIL
      perfilNomeDisplay.textContent = userData.displayName || 'Anonymous Player';
      
      if (userData.avatar) {
        avatarImg.src = userData.avatar;
      }
      
      if (userData.playerId) {
        playerIdDisplay.textContent = userData.playerId;
      } else {
        playerIdDisplay.textContent = 'Not registered';
        playerIdDisplay.style.color = '#888';
      }
      
      console.log('‚úÖ User data loaded');

      if (currentUser && currentUser.uid !== userId) {
        console.log('üëÅÔ∏è Registrando visualiza√ß√£o de:', currentUser.uid, 'no perfil:', userId);
        await registrarVisualizacao(userId, currentUser.uid);
      } else if (currentUser && currentUser.uid === userId) {
        console.log('‚ÑπÔ∏è √â o pr√≥prio perfil, n√£o registrar visualiza√ß√£o');
      } else {
        console.log('‚ö†Ô∏è Usu√°rio n√£o est√° logado, n√£o pode registrar visualiza√ß√£o');
      }

      // Registrar visualiza√ß√£o (se n√£o for o pr√≥prio perfil)
      if (currentUser && currentUser.uid !== userId) {
        await registrarVisualizacao(userId, currentUser.uid);
      }
      
      // Carregar builds
      await carregarBuildsUsuario(userId);
      await carregarRibbonsUsuario(userId);
      
    } catch (error) {
      console.error('‚ùå Error loading user:', error);
      alert('‚ùå Error loading profile');
      window.location.href = '../index.html';
    }
  }

// ===== SUBSTITUA A FUN√á√ÉO carregarBuildsUsuario POR ESTA =====

async function carregarBuildsUsuario(uid) {
  try {
    buildsContainer.innerHTML = '<div class="builds-loading">Loading builds...</div>';
    
    const buildsRef = collection(db, "usuarios", uid, "builds");
    const buildsSnap = await getDocs(buildsRef);
    
    if (buildsSnap.empty) {
      buildsContainer.innerHTML = `
        <div class="no-builds-message">
          This player has no saved builds yet.
        </div>
      `;
      return;
    }
    
    const builds = [];
    buildsSnap.forEach(docSnap => {
      builds.push({ id: docSnap.id, ...docSnap.data() });
    });
    
    // Ordenar por data
    builds.sort((a, b) => {
      const dateA = a.updatedAt?.toDate() || new Date(0);
      const dateB = b.updatedAt?.toDate() || new Date(0);
      return dateB - dateA;
    });
    
    // ‚≠ê VERIFICAR SE √â O PR√ìPRIO PERFIL
    const isOwnProfile = currentUser && currentUser.uid === uid;
    
    // Renderizar builds COM sistema de avalia√ß√£o
    buildsContainer.innerHTML = builds.map(build => 
      createBuildCard(build, isOwnProfile)
    ).join('');
    
    // ‚≠ê INICIALIZAR EVENTOS DE AVALIA√á√ÉO
    if (window.initRatingEvents && !isOwnProfile) {
      console.log('üéØ Inicializando eventos de avalia√ß√£o...');
      window.initRatingEvents(uid, db);
    }
    
    console.log('‚úÖ Builds loaded:', builds.length);
    
  } catch (error) {
    console.error('‚ùå Error loading builds:', error);
    buildsContainer.innerHTML = `
      <div class="no-builds-message" style="color: #ff6b6b;">
        ‚ùå Error loading builds
      </div>
    `;
  }
}

  // Carregar dados ao iniciar
  carregarDadosUsuario();
</script>

<script>
  // Menu mobile
  const menuToggle = document.querySelector('.menu-toggle');
  const mobileMenu = document.querySelector('.mobile-menu');

  menuToggle.addEventListener('click', function() {
    this.classList.toggle('ativo');
    mobileMenu.classList.toggle('ativo');
  });

  const mobileLinks = document.querySelectorAll('.mobile-menu a');
  mobileLinks.forEach(link => {
    link.addEventListener('click', function() {
      menuToggle.classList.remove('ativo');
      mobileMenu.classList.remove('ativo');
    });
  });

  window.addEventListener('resize', function() {
    if (window.innerWidth > 900) {
      menuToggle.classList.remove('ativo');
      mobileMenu.classList.remove('ativo');
    }
  });
</script>

</body>
</html>